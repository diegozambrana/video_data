define(["webrtc/adapter","OK/cookie"],(function(e,i){"use strict";var t=null,n=[],r=[],o=null,a=null,d=!1,c=!1,s=null,u=null,h=!1,v=!1,l=null;function m(e,i,t,n,r,d,c){var s=!1;e&&(s=!a||{deviceId:{exact:a.deviceId}});var u=!1;i&&(u={width:{min:t||1024,max:n||1280},height:{min:r||576,max:d||720},aspectRatio:{ideal:c||16/9}},o&&(u.deviceId={exact:o.deviceId})),this.audio=s,this.video=u}function f(e,i,t){m.call(this,!1,!0,null,e,null,i),delete this.video.deviceId,t?(this.video.mandatory={chromeMediaSource:"desktop",chromeMediaSourceId:t,minWidth:this.video.width.min,maxWidth:this.video.width.max,minHeight:this.video.height.min,maxHeight:this.video.height.max},this.video.optional=[{googTemporalLayeredScreencast:!0},{aspectRatio:16/9}],delete this.video.width,delete this.video.height,delete this.video.aspectRatio):this.video.mediaSource="screen"}function p(e){try{return JSON.parse(window.localStorage.getItem("_vc_"+e))}catch(e){return null}}function g(){return t||(navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices?t=navigator.mediaDevices.enumerateDevices().then((function(e){n=e.filter((function(e){return"videoinput"===e.kind&&(e.label&&(d=!0),!0)})),r=e.filter((function(e){return"audioinput"===e.kind&&(e.label&&(c=!0),!0)}));var i=p("videoinput"),s=p("audioinput");return o=n.find((function(e){return e.deviceId===i}))||null,a=r.find((function(e){return e.deviceId===s}))||null,t=Promise.resolve(e),e})).catch((function(){return t=null,[]})):Promise.resolve([]))}function w(e){return console.log("Try to get media",e.getNative()),navigator.mediaDevices.getUserMedia(e.getNative()).catch((function(i){switch(i.name){case"PermissionDeniedError":case"PermissionDismissedError":case"NotAllowedError":case"SecurityError":case"DOMException":return Promise.reject("permission");case"OverconstrainedError":case"TypeError":case"NotFoundError":return e.canSimplify()?w(e.simplify()):Promise.reject("unknown");case"AbortError":case"NotReadableError":return Promise.reject("access");default:return Promise.reject("unknown")}}))}function y(){return Promise.all([g(),T()?new Promise((function(e){var i={};k()&&(i.sdpSemantics="plan-b"),new window.RTCPeerConnection(i).createOffer({offerToReceiveVideo:!0}).then((function(i){/^a=rtpmap:\d+ VP8\/\d+$/m.test(i.sdp)&&(h=!0),/^a=mid:0$/m.test(i.sdp)&&(v=!0),e()})).catch(e)})):Promise.resolve()])}function S(){return n.length>0}function I(){return d}function C(){return c}function P(){return!(!window.HTMLCanvasElement||!window.HTMLCanvasElement.prototype.captureStream)&&!(!window.RTCRtpSender||!window.RTCRtpSender.prototype.replaceTrack)}function R(e,i){if(u||(u=document.createElement("canvas")).getContext("2d"),u.width=e||1024,u.height=i||576,!s||"ended"===s.readyState){var t=u.captureStream(25);s=Object.assign(t.getVideoTracks()[0],{enabled:!1})}return s}function T(){try{return navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&window.RTCPeerConnection&&window.RTCIceCandidate&&window.RTCSessionDescription&&!0}catch(e){return!1}}function k(){if(null===l){var e=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./);l=e?parseInt(e[2],10):0}return l}m.prototype.getNative=function(){return Object.assign({},{audio:this.audio,video:this.video})},m.prototype.simplify=function(){return this.video.width||this.video.height?(delete this.video.width,delete this.video.height):this.video.aspectRatio?delete this.video.aspectRatio:(this.video.deviceId||this.audio.deviceId)&&(delete this.video.deviceId,delete this.audio.deviceId),this.video&&!Object.keys(this.video).length&&(this.video=!0),this.audio&&!Object.keys(this.audio).length&&(this.audio=!0),this},m.prototype.canSimplify=function(){return!!(this.video.width||this.video.height||this.video.aspectRatio||this.video.deviceId||this.audio.deviceId)},m.prototype.isVideo=function(){return!!this.video},m.prototype.isAudio=function(){return!!this.audio},f.prototype=Object.create(m.prototype),f.prototype.constructor=m;var b={getCameras:function(){return n},getMicrophones:function(){return r},getSavedCamera:function(){return o},getSavedMicrophone:function(){return a},hasCamera:S,hasMicrophone:function(){return r.length>0},hasCameraPermission:I,hasMicrophonePermission:C,hasPermissions:function(e){return!!C()&&(!(S()&&(e||!P()))||I())},getUserMedia:function(e){return w(new m(!0,S()&&(e.video||!P()),e.minWidth,e.maxWidth,e.minHeight,e.maxHeight,e.aspectRatio)).then((function(i){return S()&&!e.video&&P()&&i.addTrack(R(e.minWidth,e.minHeight)),i}))},getUserVideo:function(e){return w(new m(!1,!0,e.minWidth,e.maxWidth,e.minHeight,e.maxHeight,e.aspectRatio))},getUserAudio:function(){return w(new m(!0,!1))},getScreenMedia:function(e){return w(new f(screen.width,screen.height,e))},canReplaceTrack:P,saveDeviceId:function(e,i){return g().then((function(t){var n=t.find((function(t){return t.kind===e&&t.deviceId===i}));return n?("videoinput"===e?o=n:a=n,function(e,i){try{window.localStorage.setItem("_vc_"+e,JSON.stringify(i))}catch(e){}}(e,i),n):null}))},getBlackMediaTrack:R,isBrowserSupported:T,getChromeVersion:k,canVP8:function(){return h},isUnifiedPlan:function(){return v}};return Object.assign({},b,{init:y,load:function(t,n,r,o){o.isBuild?r(b):(("true"===i.readCookie("dme")||OK.fn.isDebug())&&window.console&&e.disableLog(!1),y().then((function(){r(b)})))}})}));