define(["OK/utils/dom","OK/utils/vanilla","OK/utils/environment","OK/logger"],(function(e,o,t,n){var r,a,i,c,u,l=window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver;function s(e,o){var r=Array.prototype.slice.call(arguments),a=["right-column-v2"];a.push.apply(a,r),n.success.apply(n,a);try{t.isDebug&&console.info.apply(console,a)}catch(e){}}var d=function(){var e=new Promise((function(e,o){var t=setTimeout((function(){o("timeout")}),5e3);require(["OK/banners/moneySave","mrg-smokescreen/Welter"],(function(o,n){c=o,u=n,clearTimeout(t),e()}),(function(){clearTimeout(t),o("error")}))}));return d=function(){return e},e};function f(){var o=document.getElementById("fourthColumnWrapper");if(o){var t,n=document.getElementById("hook_Block_FrOln4thCol"),r=!1;if(n||(r=!!(n=document.getElementById(c.transformNow("hook_Block_FrOln4thCol")))),n){var a=e.firstByClass(n,"fo4c_h");if(a){var i=Array.prototype.slice.call(n.querySelectorAll('.fo4c_h > [id^="hook_Block"]')),l=[];i.forEach((function(e){switch(a.removeChild(e),e.id){case"hook_Block_GiftOfTheDayOrBanner":case"hook_Block_ForthColumnTopBanner":(t=e=document.createElement("div")).id="RightColumnBannerInner"}l.push(e)})),c.obfuscateNow(n,[".gifts-widget-w",".fr-motivator-portlet"],r);var s=c.transformNow("fo4c_h");if(l.forEach((function(e){a.appendChild(e)})),u.wrap(n,"."+s+' > [id^="hook_Block"]'),t)return c.obfuscateNow(t),c.attachTopRightBanner(o,t).then((function(){t.setAttribute("class",c.transformNow("banner_new__loaded"));var o=e.firstByClass(document,"friendsOnlineHook"),r=o?o.nativeHookImpl:null;return r&&r.doReflow(),n}))}}}}function h(e,o){this.message=e,this.param=o||""}function m(e){return o.updateBlockModelCallback(e),d().then((function(){return c.ready()}),(function(e){throw s("moneysaveLoad-error",e.message),new h("moneysaveLoad-error",e)})).then((function(){return c.detectAdBlock()})).then((function(o){if(!o)throw new h("moneysaveReady-noAdblock");return e}),(function(e){if(e instanceof h)throw e;throw s("moneysaveReady-error",e.message),new h("moneysaveReady-error",e&&e.message)})).then((function(e){return OK.getCurrentDesktopModelId()!==a?k(1):e})).then((function(e){o.updateBlockModelCallback(e);var t=document.getElementById("fourthColumnWrapper");u.wrap(t,'#hook_Block_FourthCol > [id^="hook_Block"]');document.getElementById("hook_Block_FrOln4thCol");return f()})).then((function(e){l&&e&&(r=new l((function(e){e.forEach((function(e){e.attributeName;"childList"===e.type&&e.addedNodes.length>0&&f()}))}))).observe(e,{childList:!0})})).catch((function(e){e instanceof h||s("error",e.message)}))}function p(){OK.getCurrentDesktopModelId&&OK.getCurrentDesktopModelId()&&OK.gwtModuleFullyFinished?k(0).then(m):i=setTimeout(p,50)}function k(e){var t=OK.getCurrentStateLink();return a=OK.getCurrentDesktopModelId(),t=(t+=(-1===t.indexOf("?")?"?":"&")+"cmd=FourthCol").replace("&st.layer.cmd=PopLayerClose",""),o.ajax({url:t}).catch((function(o){throw s("request-"+e+"-error"),o}))}return{activate:function(e){p()},deactivate:function(e){r&&(r.disconnect(),r=null),i&&clearTimeout(i)}}}));