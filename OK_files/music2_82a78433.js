define("OK/css-loader",[],(function(){"use strict";function t(t,e,n){for(var r=document.getElementsByTagName("link"),a=0,i=r.length;a<i;a++)if(r[a].getAttribute("href")===t)return void(n&&n(r[a]));var c=document.createElement("link");c.rel="stylesheet",c.type="text/css",c.href=t,n&&(c.addEventListener("load",(function(){n(t)})),c.addEventListener("error",(function(t){n.error(t)}))),(document.head||document.getElementsByTagName("head")[0]).appendChild(c)}return{load:t,activate:function(e){var n=e.getAttribute("data-url");n&&t(n)}}})),define("OK/music2/app",["module","OK/logger","OK/CurrentUserCfg","OK/css-loader"],(function(t,e,n,r){"use strict";var a,i=null,c=null,s=[];function u(t,e){return e&&r.load(requirejs.toUrl("music/layer")+".css"),new Promise((function(e,n){require([t],e,n)}))}function o(){return u("music/model").then((function(e){c=e(n.getInstance().getUserId(),t.config().host,t.config().uploadHost);var r={player:{}};return c.subscribe((function(){var t=c.getState(),e=r.player,n=t.player;t!==r&&(e===n||e.track===n.track&&e.playing===n.playing||s.forEach((function(t){f("current-track-changed",t,d()||{id:void 0,playing:!1})})),r=t)})),c}))}function l(){return i||(i=o())}function d(){if(c){var t=c.getState().player;if(t.track)return Object.assign({},t.track,{playing:t.playing})}return null}function p(t){t.getState().player.playing?t.player.pause():t.player.play()}function y(t,e){s.push(e)}function m(t,e){var n=s.indexOf(e);n>-1&&s.splice(n,1)}function f(t,n,r){try{"current-track-changed"===t&&n.handleTrackChange?n.handleTrackChange(r):n(r)}catch(n){e.clob("music.app.error",n.stack,"notify",t)}}return setTimeout(l,2500),a={v2:!0,model:function(){return c},activate:l,playing:function(){return!!c&&c.getState().player.playing},getCurrentTrack:d,togglePlaying:function(){p(c)},play:function(t,e){var n=c.getState().player;n&&n.track&&n.track.id===t?p(c):c.player.play(t,e)},playQueue:function(t,e,n){var r=c.getState().player;return r.playing&&r.queue.type===t&&r.queue.id===e?(p(c),Promise.resolve()):c.player.playQueue(t,e,n)},pause:function(){c&&c.player.pause()},loadMyTracks:function(){return c.library.fetchTracks().then((function(t){return t.items}))},searchTracks:function(t){return c.search.loadResults("tracks",t).then((function(t){return t.results.items}))},addTrack:function(t,e){return c.tracks.add({id:t,ctx:e})},addPlaylist:function(t){return c.playlists.add(t)},removePlaylist:function(t){return c.playlists.remove(t)},share:function(t,e,n){return c.sharing.share(t,e,n)},on:y,once:function(t,e){y(0,(function n(r){m(0,n),f(t,e,r)}))},off:m,mountLayer:function(t){var e=l().then((function(t){return t.init(),t})),n=u("music/layer",!0);return r.load(requirejs.toUrl("music/layer")+".css"),require(["OK/pts!music"],(function(){})),Promise.all([e,n]).then((function(e){var n=e[0];return(0,e[1])(t,n,{id:"music_layer",theme:t.getAttribute("data-theme")})}))},mountMiniPlayer:function(t){return u("music/mini-player",!0).then((function(e){return e(t,c)}))}},["play","playQueue","loadMyTracks","searchTracks","addTrack","addPlaylist","removePlaylist","share"].forEach((function(t){var e=a[t];a[t]=function(){var t=arguments;return c?e.apply(null,t):l().then((function(){return e.apply(null,t)}))}})),a})),define("OK/music2/bind-events",["OK/logger","OK/ToolbarBubble","OK/utils/vanilla"],(function(t,e,n){"use strict";var r=document.getElementById("music_layer_wrapper");function a(t){n.ajax({url:"/dk",data:t}).then(n.updateBlockModelCallback)}return function(t){var i=function(e,n){t.addEventListener(e,(function(t){n(t.detail)}))};i("show-subscription-layer",(function(){a({cmd:"PopLayer","st.layer.cmd":"PopLayerPaymentWizardOuter","st.layer.origin":41,"st.layer.srv":26,"st.layer.stJsCb":"ms"})})),i("share-track",(function(t){a({cmd:"PopLayerOver","st.layer.cmd":"PopLayerReshare","st.layer.xpostType":t.target,"st.layer.refId1":t.id,"st.layer.type":13})})),i("share-playlist",(function(t){a({cmd:"PopLayerOver","st.layer.cmd":"PopLayerReshare","st.layer.xpostType":t.target||"Feed","st.layer.refId1":t.id,"st.layer.refIdStr":t.type||"playlist","st.layer.type":14})})),i("show-mediatopic-layer",(function(t){require(["OK/MediaLayer"],(function(e){e.showTopicInLayer(t.mediatopicId,t.mediatopicOwner)}))})),i("send-present",(function(t){a({cmd:"PopLayer","st.layer.cmd":"PopLayerSendPresentSelectFriendComposite","st.layer.trackId":t.trackId})})),i("buy-track",(function(t){a({cmd:"PopLayer","st.layer.cmd":"PopLayerPaymentWizardOuter","st.layer.appId":90280448,"st.layer.timestamp":Date.now(),"st.layer.appCode":t.id,"st.layer.appName":t.name,"st.layer.currency":"RUR","st.layer.appPrice":t.price,"st.layer.callback":!0,"st.layer.srv":22,"st.layer.appCardOnly":"off"})})),i("open-portal-link",(function(t){OK.Layers.unregisterAll(),window.navigateOnUrlFromJS(t)})),i("show-music-video",(function(t){a({"st.vpl.id":t.id,"st.cmd":"userMain","st.vpl.vs":"musicVideos","st.vpl.ft":t.fromTime,"st.vpl.vp":t.playlist&&t.playlist.join(",")})})),i("counter-update",(function(t){e.wrap("counter_ToolbarMusic").update(t.count)})),i("history-change",(function(t){t.state!==OK.historyManager.getState()&&OK.historyManager.pushState(t.state)})),i("playlist-update",(function(){"altGroupMusic"===OK.getCurrentDesktopModelId()&&n.ajax({url:OK.getCurrentStateLink()}).then(n.updateBlockModelCallback)})),i("inner-layer-opened",(function(t){r.classList.toggle("__layer-open",t)}))}})),define("OK/music2/preloader",[],(function(){var t,e,n,r,a,i=!1,c=1e3,s=48,u=4;function o(t){return{start:0,end:2*Math.PI*t}}function l(t){return{start:2*Math.PI*t,end:2*Math.PI}}function d(){var t,i=Math.min((Date.now()-n)/c,1),o=r((t=i)<.5?2*t*t:(4-2*t)*t-1);e.clearRect(0,0,2*s,2*s),e.beginPath(),e.arc(s,s,s-u,o.start,o.end),e.stroke(),i<1?a=requestAnimationFrame(d):p()}function p(){r=r===o?l:o,n=Date.now(),a=requestAnimationFrame(d)}return{start:function(){if(!i){var n=document.getElementById("music-preloader");(t=document.createElement("canvas")).width=2*s,t.height=2*s,t.style.width=s+"px",t.style.height=s+"px",n.appendChild(t),(e=t.getContext("2d")).lineCap="round",e.lineWidth=2*u,e.strokeStyle="#f9912f",i=!0,p()}},stop:function(){i=!0,t&&(cancelAnimationFrame(a),t.parentElement.removeChild(t),t=null)}}})),define("OK/music2/layer",["OK/logger","OK/music2/app","OK/music2/bind-events","OK/music2/preloader"],(function(t,e,n,r){"use strict";var a,i,c="music_app",s="toolbar_nav_a__audio__active",u="invisible",o=document.getElementById("music_toolbar_button"),l=document.getElementById("music_layer_wrapper"),d=document.getElementById("music_layer_holder");function p(){return OK.Layers&&OK.Layers.isLayerOpened(c)}function y(){OK.historyManager.pushState(a),i&&i.close(),o.classList.remove(s),l.classList.add(u),OK.Layers.remove(c),OK.Layers.onLayerHidden()}function m(){return p()||(o.classList.add(s),l.classList.remove(u),OK.Layers.unregisterAll(),OK.Layers.onLayerShown(),OK.Layers.register(c,y)),i?Promise.resolve(i):(r.start(),e.mountLayer(d).then((function(e){return t.success("music","start","activated"),i=e,r.stop(),n(i),e})).catch((function(e){throw t.clob("musicclob.error",e.stack,"music-start","activate"),y(),e})))}return{id:c,isOpen:p,open:function(t){return m().then((function(e){a=OK.historyManager.getState()||"/",e.open(t)}))},close:function(){this.isOpen()&&y()}}})),define("OK/music2/toolbar-button",["OK/ToolbarGrowl","OK/music2/app","OK/music2/layer"],(function(t,e,n){"use strict";return{activate:function(r){r.addEventListener("click",(function(t){t.stopPropagation(),n.isOpen()?n.close():n.open()})),r.getAttribute("data-short-link")&&n.open(OK.historyManager.getState()),e.once("current-track-changed",(function(){t.destroyByLayerId(n.id),e.mountMiniPlayer(r).then((function(t){t.addEventListener("open-layer",(function(){n.open()})),t.addEventListener("open-current",(function(){n.open("/music/current")}))}))}))}}})),define("OK/music2/play-button",["OK/music2/app"],(function(t){"use strict";return{activate:function(e){var n=e.getAttribute("data-track-id"),r=e.getAttribute("data-track-ctx"),a=e.getAttribute("data-playlist-id"),i=e.getAttribute("data-playlist-type");t.on("current-track-changed",(function(t){e.classList.toggle("toolbar_music-play__active",!(!t||!t.playing))})),e.addEventListener("click",(function(e){var c=t.getCurrentTrack();e.stopPropagation(),c?c.playing?t.pause():t.play():n?t.play(Number(n),{type:Number(i),id:a,ctx:r}):t.playQueue(8)}))}}})),define("OK/music2/push",["OK/logger","OK/NewsFetchCoordinator","OK/ToolbarBubble","OK/utils/vanilla"],(function(t,e,n,r){function a(t){var e=document.getElementById("music_layer");"STATUS"===t.type&&n.wrap("counter_ToolbarMusic").update(t.payload.subscriptionsUpdates),e&&e.setNewEvent&&e.setNewEvent(t)}function i(e){setTimeout((function(){(t.success("music","polling","request"),r.ajax({url:"/web-api/music/status",dataType:"json"})).then((function(n){a({type:"STATUS",payload:n.response}),t.success("music","polling","request-success"),i(e)})).catch((function(){t.success("music","polling","request-error"),i(e)}))}),e)}return{activate:function(t){var n=Number(t.getAttribute("data-timeout"));n>0&&i(n),e.addBlock("MP")},setNewContent:function(t){OK.util.parseJsonCorrected(t).events.forEach(a)}}})),define("OK/music2/theme",["OK/utils/vanilla"],(function(t){"use strict";return{activate:function(e){if((r=window.CSS&&window.CSS.supports.bind(window.CSS)||window.supportsCSS)&&r("color","var(--primary)")){var n=e.getAttribute("data-id");e.addEventListener("click",(function(){!function(e){var n=document.getElementById("music_layer");n&&(n.setAttribute("theme",e),t.ajax({url:"/web-api/music/theme?name="+e}))}(n="dark"===n?"light":"dark")})),e.classList.remove("invisible")}var r}}})),define("OK/music2/last-played-growl",["OK/logger","OK/music2/app","OK/music2/layer"],(function(t,e,n){"use strict";return{activate:function(t){this.trackId=Number(t.getAttribute("data-track-id")),this.trackCtx=t.getAttribute("data-track-ctx"),this.playlistId=t.getAttribute("data-playlist-id"),this.playlistType=Number(t.getAttribute("data-playlist-type")),t.addEventListener("click",this)},deactivate:function(t){t.removeEventListener("click",this)},handleEvent:function(t){t.stopPropagation(),e.play(this.trackId,{type:this.playlistType,id:this.playlistId,ctx:this.trackCtx}),n.open("/music/current")}}})),define("OK/music2/growl-close",["OK/utils/vanilla"],(function(t){"use strict";function e(t,e){this.type=e.getAttribute("data-type")}return e.prototype={activate:function(t){t.addEventListener("click",this)},deactivate:function(t){t.removeEventListener("click",this)},handleEvent:function(){t.ajax({url:"/web-api/music/markActionHide?type="+this.type})}},e})),define("b/music2",["OK/music2/app","OK/music2/bind-events","OK/music2/layer","OK/music2/toolbar-button","OK/music2/play-button","OK/music2/push","OK/music2/preloader","OK/music2/theme","OK/music2/last-played-growl","OK/music2/growl-close"],{});