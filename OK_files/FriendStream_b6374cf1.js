define(["OK/utils/utils","OK/utils/dom","OK/UserClientCache","OK/logger","OK/NewsFetchCoordinator","OK/SortedLinkedList","PTS/friendstream.client"],(function(e,t,i,n,s,r,o){"use strict";function a(e){this.element=e,this.actorId=parseInt(e.getAttribute("data-aid"),10),this.position=parseInt(e.getAttribute("data-pos")||0,10)}function d(e){this.items=[],this.maxSize=e}function l(e){this.element=e,this.count=0}a.prototype={getTime:function(){return this.time?this.time:this.time=new Date(parseInt(this.element.getAttribute("data-time"),10))},isOfflineEvent:function(){return this.isOffline?this.isOffline:this.isOffline="true"===this.element.getAttribute("data-offline")},compareTo:function(e){return this.position-e.position}},d.prototype={append:function(e){var t=1;return this.items.length===this.maxSize&&(t=0,this.items.shift()),this.items[this.items.length]=e,t},drain:function(){for(var e=this.items.length;this.items.length>0;){var t=this.items.shift();T.insert(t)}return e}},l.prototype={update:function(e){this.initialized||(this.element.addEventListener("click",this.click.bind(this)),this.initialized=!0),this.count+=e;var i="collapsed.count."+OK.util.plurals(this.count);t.firstByClass(this.element,"online-fr_new-actions-notification").innerHTML=o[i];var n=t.firstByClass(this.element,"counterText");void 0!==n&&(n.innerText=this.count.toString()),this.count>0?this.show():this.hide()},click:function(e){var t=I.drain();n.success("friendStream","expand",""+t),e.preventDefault()},reset:function(){this.update(-this.count)},hide:function(){this.element.classList.remove("__update"),OK.showOnlineUsers.doResize()},show:function(){this.element.classList.add("__update"),OK.showOnlineUsers.doResize()}};var c,u,h,f,m,v=25,p=e.deferred(),g={},O={},w=new d(v),y={accept:function(e,t,i){i?e.insert(t):h.update(w.append(t))},drain:function(){return h.reset(),w.drain()},enable:function(){},disable:function(){}},b={showPreviewTimer:void 0,temporary:[],accept:function(e,t,i){i||(this.temporary.push(t),h.update(w.append(t))),e.insert(t),this.preview(1,5e3)},drain:function(){},onHover:function(){var e=y.drain();n.success("friendStream","expand.hover",""+e),b.removeTemporary(),m.classList.add("__hover"),t.one(m,"mouseleave",(function(){m.classList.remove("__hover")}))},enable:function(){m.addEventListener("mouseenter",this.onHover)},disable:function(){m.removeEventListener("mouseenter",this.onHover),b.removeTemporary()},removeTemporary:function(){for(;this.temporary.length>0;)t.remove(this.temporary.shift())},preview:function(e,i){var n=this;this.showPreviewTimer&&clearInterval(this.showPreviewTimer),this.showPreviewTimer=setInterval((function(){if(!OK.Layers.isAnyLayerOpened()){var e=t.firstByClass(document,"online-fr_list"),s=document.getElementById("hook_Block_UserTODO");e.style.maxHeight="64px",m.style.maxHeight=s.clientHeight+110+"px",setTimeout((function(){m&&e&&(e.style.maxHeight="",m.style.maxHeight="")}),i),clearInterval(n.showPreviewTimer)}}),100)}},I=y;function S(e,t){var i=O[t];if(i){for(var n=i.element.nextSibling;n;)K(n,-1),n=n.nextSibling;e.remove(i);var s=c.find((function(e){return e.actorId===t}));s&&s.remove()}}function K(e,t){var i=e.getAttribute("data-l");i&&(i.indexOf("position,")>-1?e.setAttribute("data-l",i.replace(/position,(\d+)/,(function(e,i){return"position,"+(parseInt(i,10)+t)}))):e.setAttribute("data-l",i+",position,0"))}var T={activate:function(e){v=parseInt(e.getAttribute("data-max"),10),u=OK.hookModel.getNearestBlockHookId(e);var t=document.getElementById("friendstream-collapsed");f="1"===t.getAttribute("data-force-collapsed"),h=new l(t),m=document.getElementById("online-fr_block"),c=new r,p.resolve(e),s.addBlock("FSC"),OK.loader.use(["OKCustomJs","nativeHooks"],(function(){OK.showOnlineUsers.doResize()})),OK.onload.addCallback(this.toggleState)},add:function(e){c.getSize()===v&&this.removeEarliest();var t=new a(e);return g[t.actorId]=(g[t.actorId]||0)+1,t.isOfflineEvent()&&(O[t.actorId]=t),c.add(t)},removeEarliest:function(){var e=c.getTail(),t=e.value;return this.remove(t),c.remove(e)},remove:function(e){t.remove(e.element),g[e.actorId]=g[e.actorId]-1,e.isOfflineEvent()&&delete O[e.actorId]},setNewContent:function(e){var t=this,s=document.createElement("div");s.innerHTML=e;var r=OK.util.parseJSON(s.firstChild.innerHTML),o=Array.prototype.slice.call(s.childNodes,1);r.isPush||n.success("friendStream","setNewContent","not-push"),p.promise.then((function(){n.success("friendStream","setNewContent","push");var e=r.users;for(var s in e)if(e.hasOwnProperty(s)){var a=e[s];i.add(parseInt(s,10),a.onlineStatus)}o.length>0&&document.getElementById("online-fr_block").classList.add("__has-friends");for(var d=o.length-1;d>=0;d--){var l=o[d],c="true"===l.getAttribute("data-important");I.accept(t,l,c)}}))},insert:function(e){p.promise.then((function(t){var i=parseInt(e.getAttribute("data-aid"),10),s="true"===e.getAttribute("data-online");if(S(T,i),s&&g[i]>0)n.success("friendStream","setNewContent","skipped");else{document.hidden||e.classList.add("__push"),t.insertBefore(e,t.firstChild);for(var r=e.nextSibling;r;)K(r,1),r=r.nextSibling;OK.hookModel.captureBlockHook(u,e),document.hidden&&OK.showOnlineUsers.doResize(),n.success("friendStream","setNewContent","appended")}}))},toggleState:function(){I.disable(),(I=f?b:OK.isStateRedesign()?y:OK.util.is4ColumnActive()?y:b).enable()}};return T}));