define(["exports","PTS/messaging.client","OK/ToolbarBubble","OK/FaviconManager","OK/utils/vanilla","OK/NewsFetchCoordinator"],function(e,n,a,s,o,m){"use strict";n=n&&n.hasOwnProperty("default")?n.default:n;var r="messages.nmst",t="messages.pnms",i=null,c=null;function u(e){window.HTMLAudioElement?(function(e){if(null!=i&&e===c)return;var t=new Audio,n=function(e){var t="probably",n=e.canPlayType("audio/mp3"),s=e.canPlayType("audio/wav");return n!==t?s!==t?"maybe"!==n?"maybe"!==s?(OK.logger.success(r,"err"),null):(OK.logger.success(r,"wav.mb"),".wav"):(OK.logger.success(r,"mp3.mb"),".mp3"):(OK.logger.success(r,"wav.pb"),".wav"):(OK.logger.success(r,"mp3.pb"),".mp3")}(t);if(!n)return;t.src=e+n,t.volume=0,t.play(),c=e,i=t}(e),i.pause(),i.src=i.src,i.volume=1,i.play(),OK.logger.success(t)):OK.logger.success(r,"ns")}var l,g=document.title;function v(e){document.title=e}function d(e){if(clearTimeout(l),Array.isArray(e)){var t=0,n=function(){v(e[t++]),t%=e.length,l=setTimeout(n,700)};n()}else v(e)}var f="notification_enabled_messenger",p=[];function h(){return window.Notification&&"granted"===window.Notification.permission&&window.localStorage&&"0"!==window.localStorage.getItem(f)}function w(e,t,n,s,a){void 0===n&&(n=OK.cnst.staticUrl+"res/i/html5_notif_icon.png");var o=new Notification(e,{body:t,icon:n,tag:s});return o.onshow=function(){OK.logger.success("html5.ntf.shown"),setTimeout(o.close.bind(o),7e3)},o.onclose=function(){p.some(function(e,t){if(e===o)return p.splice(t,1),!0})},o.onclick=function(){OK.logger.success("html5.ntf.click"),a&&a()},p.push(o),o}var y="hasFocus"in document,b=!0;window.addEventListener("focus",function(){return b=!0}),window.addEventListener("blur",function(){return b=!1});var M=[],T=!1,O="PRIVATE",C={count:0,privateConv:0,chatConv:0,privateMessages:0,chatMessages:0,updateMessagesTime:0,readMarksTime:0,typingStatusesTime:0};function k(){m.addBlock("MPC"),T=!0}function K(){m.removeBlock("MPC"),T=!(M=[])}function S(t){return T||k(),M.push(t),function(){var e=M.indexOf(t);-1!==e&&(M.splice(e,1),0===M.length&&K())}}function I(e,n){return e.filter(function(e){var t="number"==typeof n?n:n(e);return!(e.time&&e.time<=t)})}function E(e){return"number"==typeof e?e:parseInt(e,10)||0}function _(e,t){return e+(e.length?":":"")+t}var L,A=a.wrap("counter_ToolbarMessages"),P=document.getElementById("msg_toolbar_button"),B=Boolean(P&&P.getAttribute("data-button-add-log")),N=3e3,j=[],F="msg-play-sound",G=!1,U=0,x=0,R=!1,V=!1,D=!1;function H(){return OK.lss&&OK.lss.isMaster()}function J(){var e=performance.now();x&&e-x<N||(x=e,u(OK.cnst.staticUrl+"res/default/sound/newMessageSound15"))}function q(){H()?J():localStorage.getItem(F)||(localStorage.setItem(F,"play"),setTimeout(function(){return localStorage.removeItem(F)},1))}function z(){var e,t;G||(0<U?(e=U,t=OK.util.plurals(e),d(e+" "+n["new.message.count."+t])):(s.removeFavicon(0),d(g)))}function Q(e){0<(U=e)&&(G=!0,s.registerFavicon(0),d([n["new.message.title"],"* * * * * * * * * * * *"]),L&&clearTimeout(L),L=setTimeout(function(){G=!1,z()},5e3)),z()}function W(e,a){e.forEach(function(e){var n,s,t;(n=e,s=Date.now(),(t=j.some(function(e,t){return 6e4<s-n.time&&j.splice(t,1),n.msgId===e.msgId}))||(n.time=s,j.push(n)),t)?OK.logger.success("html5.ntf.filter"):w(e.title,e.body,e.icon,String(e.chatId),function(){p.forEach(function(e){return e.close()}),p.length=0,window.focus(),a&&a(e)})})}function X(e,t){!(y?document.hasFocus():b)&&h()&&H()&&W(e,t)}function Y(e){var t=A.hasBubble();if(e){A.resolveCustomIcon(e.conv,e.hasReply),B&&OK.logger.success("messagesLayer","bubble","tt"),Q(e.conv),e.showGrowlTT&&o.ajax({url:"/dk?cmd=MessagesGrowl"}).then(function(e){return o.updateBlockModelCallback(e)});var n=a.create("counter_UserMessages");n&&n.resolveCustomIcon(e.conv-e.group);var s=a.create("counter_GroupMessages");s&&s.resolveCustomIcon(e.group)}else t||A.resolveCustomIcon(0,!1)}H()&&localStorage.removeItem(F),window.addEventListener("storage",function(e){e&&e.key===F&&e.newValue&&H()&&J()}),e.activate=k,e.notifyUnread=Y,e.playSoundTT=q,e.pushStop=K,e.pushSubscribe=S,e.setNewContent=function(e){try{if(e){var t=OK.util.parseJSON(e);t&&(function(n){var e=n.unreadCount;e&&e.time&&C.count&&e.time<=C.count&&(n.unreadCount=void 0);var s=n.updatedConversations;s&&(C.privateConv||C.chatConv)&&Object.keys(s).forEach(function(e){var t=s[e];t.time&&t.time<=(t.type===O?C.privateConv:C.chatConv)&&delete n.updatedConversations[e]});var a=n.newMessages;a&&(C.privateMessages||C.chatMessages)&&Object.keys(a).forEach(function(e){var t=a[e];a[e]=I(t,function(e){return e.type===O?C.privateMessages:C.chatMessages})});var o=n.updatedMessages;o&&C.updateMessagesTime&&Object.keys(o).forEach(function(e){var t=o[e];o[e]=I(t,C.updateMessagesTime)});var r=n.readMarks;r&&C.readMarksTime&&Object.keys(r).forEach(function(e){var t=r[e].list;r[e].list=I(t,C.readMarksTime)});var i=n.typingStatuses;i&&C.typingStatusesTime&&Object.keys(i).forEach(function(e){var t=i[e].list;i[e].list=I(t,C.typingStatusesTime)})}(t),function(e){if(!e)return;M.forEach(function(t){try{t(e)}catch(e){OK.logger.error("messagesLayer","pushCtrl_"+t.name),OK.logger.clob("error",e.toString(),"messagesLayer","pushListener_applyNews")}})}(t),function(e){var t,n=e.unreadCount;n&&n.time&&(t=E(n.time))>C.count&&(C.count=t);var s=e.checkTime;if(!s)return;var a="",o=s.privateConvTime;o&&(t=E(o))>C.privateConv&&(C.privateConv=t);a=_(a,C.privateConv);var r=s.chatConvTime;r&&(t=E(r))>C.chatConv&&(C.chatConv=t);a=_(a,C.chatConv);var i=s.privateMessagesTime;i&&(t=E(i))>C.privateMessages&&(C.privateMessages=t);a=_(a,C.privateMessages);var c=s.chatMessagesTime;c&&(t=E(c))>C.chatMessages&&(C.chatMessages=t);a=_(a,C.chatMessages);var u=s.updateMessagesTime;u&&(t=E(u))>C.updateMessagesTime&&(C.updateMessagesTime=t);var l=s.readMarksTime;l&&(t=E(l))>C.readMarksTime&&(C.readMarksTime=t);var g=s.typingStatusesTime;g&&(C.typingStatusesTime=E(g));0<a.length&&m.updateParam("st.mpCheckTime",a)}(t))}}catch(e){OK.logger.error("messagesLayer.error","pushSetNewCnt"),OK.logger.clob("error",e.stack,"messagesLayer","processPush")}},e.showNotificationsTT=X,e.start=function(e,s){V=!!e.getAttribute("data-can-play"),D=!!e.getAttribute("data-can-notif"),"1"===e.getAttribute("data-growl")&&A.hasBubble()&&("1"===e.getAttribute("data-growl-add-log")&&OK.logger.success("messagesLayer","messageGrowlLoad","tt"),o.ajax({url:"/dk?cmd=MessagesGrowl"}).then(function(e){o.updateBlockModelCallback(e)})),R||S(function(e){Y(e&&e.unreadCount);var t=e&&e.alerts,n=t&&t.notifications;n&&0<n.length&&(V&&q(),D&&X(n,s))})},e.stop=function(){R=!0,K()},e.updateUnread=Q,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=notifier_802f3dec.js.map
