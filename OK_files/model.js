define(["require","OK/logger"],function(t,e){"use strict";e=e&&e.hasOwnProperty("default")?e.default:e;var r=10,i=1e3,s=new Map;function n(t,e,n,o){var u=n?e+function(t){for(var e=[],r=0,i=Object.keys(t);r<i.length;r+=1){var s=i[r],n=t[s];a(n)&&e.push(s+"="+encodeURIComponent(String(t[s])))}return"?"+e.join("&")}(n):e,c=s.get(u);return c||(c=function t(e,s,n,a){void 0===a&&(a=1);return function(t,e,r){return new Promise(function(i,s){var n=new XMLHttpRequest;n.open(t,e),n.setRequestHeader("Accept","application/json, text/javascript, */*; q=0.01"),r||n.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),n.onerror=function(){return s(new Error("error.network"))},n.onload=function(){if(200===n.status)try{var t=JSON.parse(n.responseText),e=t.error;e?s(new Error(e)):i(t)}catch(t){s(t)}else s(new Error(n.statusText))},n.send(r)})}(e,s,n).catch(function(o){if("error.network"!==(u=o).message&&"error.service.not.available"!==u.message&&"error.tuners.unavailable"!==u.message||a>=r)throw o;var u;return new Promise(function(r,o){setTimeout(function(){return t(e,s,n,++a).then(r,o)},i)})})}(t,u,o).then(function(t){return s.delete(u),t}).catch(function(t){throw s.delete(u),t}),s.set(u,c)),c}function a(t){return null!=t&&""!==t}function o(t,r){e.duration("music.api.request",performance.now()-t,r)}var u=function(t){void 0===t&&(t="ru"),this.locale=t};u.prototype.get=function(t,e){return this.request("GET",t,this.addParams(e))},u.prototype.post=function(t,e){return e&&e instanceof FormData?this.request("POST",t,void 0,e):this.request("POST",t,this.addParams(e))},u.prototype.createURL=function(t){return this.credentials||(this.credentials=n("POST","/web-api/music/conf")),this.credentials.then(function(e){return 0===t.indexOf("https://")?t+";jsessionid="+e.sid:(0===t.indexOf("upload/")?e.uploadHost+"/api/v1":e.apiHost)+"/"+t+";jsessionid="+e.sid})},u.prototype.request=function(t,r,i,s){var a=this,u=performance.now();return this.createURL(r).then(function(e){return n(t,e,i,s)}).then(function(t){return o(u,r),t}).catch(function(n){if(o(u,r),"error.notloggedin"===n.message)return a.credentials=void 0,a.request(t,r,i,s);throw function(t,r,i,s){if(function(t){return"error.notloggedin"!==t.message&&"error.service.not.available"!==t.message&&"error.tuners.unavailable"!==t.message&&"error.play.track.unplayable"!==t.message&&"error.copyright.restriction"!==t.message&&"error.notfound"!==t.message&&"error.network"!==t.message&&"error.privacy.restricted"!==t.message}(t)){var n="params: "+(i?JSON.stringify(i):"<empty>")+"\ndata: "+(s?"yes":"no")+"\n"+Error().stack;e.clob("music.api.error",n,r,t.message)}else e.success("music.api.error",r,t.message)}(n,r,i,s),n})},u.prototype.addParams=function(t){return void 0===t&&(t={}),t.client="web",t.locale=this.locale,t.imgfmt="base",t};var c,p,l={more:!0},d=function(t,e,r,i){void 0===r&&(r={}),this.items=t,this.loading=e,this.chunk=r,this.totalCount=i},h={hasMore:{configurable:!0},isEmpty:{configurable:!0},isNotEmpty:{configurable:!0},from:{configurable:!0}};function f(t){return t?t.reduce(function(t,e){return t[e.id]=e,t},{}):{}}function m(t,e){return{id:t.id,name:t.name,ensemble:t.ensemble,artists:k(t),artistFeatIndex:t.artistFeatIndex,album:{id:t.albumId,name:e?e.name:""},cover:t.imageUrl,duration:t.duration,giftPrice:t.giftPrice,musicVideoId:t.musicVideoId,copyrightOwnerName:t.copyrightOwnerName,isDownloadAllowed:t.isDownloadAllowed,idForDownload:t.idForDownload,playRestricted:t.playRestricted,editRestricted:t.editRestricted,subscription:t.subscription,similarityWeight:t.similarityWeight,releaseId:t.releaseId,new:t.new,copyrightDbg:t.copyrightDbg,ctx:t.ctx}}function y(t,e){return function(t,e){return t.map(function(t){var r=e[t.albumId];return m(t,r)})}(t,!e||Array.isArray(e)?f(e):e)}function g(t,e){return t.map(function(t){return m(t,e)})}function k(t){return 0===t.allArtists.length?[{id:t.masterArtistId,name:t.ensemble}]:t.allArtists}d.of=function(t,e,r){return void 0===e&&(e={}),new d(t,!1,e,r||e.more?r:t.length)},d.loading=function(){return p||(p=new d([],!0,l)),p},d.empty=function(t){return t?new d([],!1,l,t):(c||(c=new d([],!1,l)),c)},h.hasMore.get=function(){return!!this.chunk.more},h.isEmpty.get=function(){return 0===this.items.length},h.isNotEmpty.get=function(){return!this.isEmpty},h.from.get=function(){var t=this.chunk,e=t.start;void 0===e&&(e=0);var r=t.count;return void 0===r&&(r=0),e+r},d.prototype.setLoading=function(t){return this.create(this.items,t,this.chunk,this.totalCount)},d.prototype.setItems=function(t){return this.create(t,this.loading,this.chunk,this.totalCount)},d.prototype.setTotalCount=function(t){return this.create(this.items,this.loading,this.chunk,t)},d.prototype.add=function(t,e,r){return void 0===e&&(e={}),this.isSameChunk(e)?this:this.create(this.items.concat(t),!1,e,r||this.totalCount)},d.prototype.clone=function(){return this.setItems(this.items.slice())},d.prototype.create=function(t,e,r,i){return void 0===r&&(r={}),new d(t,e,r,i)},d.prototype.isSameChunk=function(t){var e=this.chunk,r=e.count,i=e.start,s=e.more;return t.count===r&&t.start===i&&t.more===s},Object.defineProperties(d.prototype,h);var v="0123456789abcdef".split("");function b(t){return function(t){for(var e=[],r=0;r<t.length;r++)e[r]=w(t[r]);return e.join("")}(function(t){var e,r=t.length,i=[1732584193,-271733879,-1732584194,271733878];for(e=64;e<=t.length;e+=64)T(i,O(t.substring(e-64,e)));t=t.substring(e-64);var s=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(e=0;e<t.length;e++)s[e>>2]|=t.charCodeAt(e)<<(e%4<<3);if(s[e>>2]|=128<<(e%4<<3),e>55)for(T(i,s),e=0;e<16;e++)s[e]=0;return s[14]=8*r,T(i,s),i}(t))}function w(t){for(var e="",r=0;r<4;r++)e+=v[t>>8*r+4&15]+v[t>>8*r&15];return e}function T(t,e){var r=t[0],i=t[1],s=t[2],n=t[3];r=P(r,i,s,n,e[0],7,-680876936),n=P(n,r,i,s,e[1],12,-389564586),s=P(s,n,r,i,e[2],17,606105819),i=P(i,s,n,r,e[3],22,-1044525330),r=P(r,i,s,n,e[4],7,-176418897),n=P(n,r,i,s,e[5],12,1200080426),s=P(s,n,r,i,e[6],17,-1473231341),i=P(i,s,n,r,e[7],22,-45705983),r=P(r,i,s,n,e[8],7,1770035416),n=P(n,r,i,s,e[9],12,-1958414417),s=P(s,n,r,i,e[10],17,-42063),i=P(i,s,n,r,e[11],22,-1990404162),r=P(r,i,s,n,e[12],7,1804603682),n=P(n,r,i,s,e[13],12,-40341101),s=P(s,n,r,i,e[14],17,-1502002290),r=I(r,i=P(i,s,n,r,e[15],22,1236535329),s,n,e[1],5,-165796510),n=I(n,r,i,s,e[6],9,-1069501632),s=I(s,n,r,i,e[11],14,643717713),i=I(i,s,n,r,e[0],20,-373897302),r=I(r,i,s,n,e[5],5,-701558691),n=I(n,r,i,s,e[10],9,38016083),s=I(s,n,r,i,e[15],14,-660478335),i=I(i,s,n,r,e[4],20,-405537848),r=I(r,i,s,n,e[9],5,568446438),n=I(n,r,i,s,e[14],9,-1019803690),s=I(s,n,r,i,e[3],14,-187363961),i=I(i,s,n,r,e[8],20,1163531501),r=I(r,i,s,n,e[13],5,-1444681467),n=I(n,r,i,s,e[2],9,-51403784),s=I(s,n,r,i,e[7],14,1735328473),r=A(r,i=I(i,s,n,r,e[12],20,-1926607734),s,n,e[5],4,-378558),n=A(n,r,i,s,e[8],11,-2022574463),s=A(s,n,r,i,e[11],16,1839030562),i=A(i,s,n,r,e[14],23,-35309556),r=A(r,i,s,n,e[1],4,-1530992060),n=A(n,r,i,s,e[4],11,1272893353),s=A(s,n,r,i,e[7],16,-155497632),i=A(i,s,n,r,e[10],23,-1094730640),r=A(r,i,s,n,e[13],4,681279174),n=A(n,r,i,s,e[0],11,-358537222),s=A(s,n,r,i,e[3],16,-722521979),i=A(i,s,n,r,e[6],23,76029189),r=A(r,i,s,n,e[9],4,-640364487),n=A(n,r,i,s,e[12],11,-421815835),s=A(s,n,r,i,e[15],16,530742520),r=S(r,i=A(i,s,n,r,e[2],23,-995338651),s,n,e[0],6,-198630844),n=S(n,r,i,s,e[7],10,1126891415),s=S(s,n,r,i,e[14],15,-1416354905),i=S(i,s,n,r,e[5],21,-57434055),r=S(r,i,s,n,e[12],6,1700485571),n=S(n,r,i,s,e[3],10,-1894986606),s=S(s,n,r,i,e[10],15,-1051523),i=S(i,s,n,r,e[1],21,-2054922799),r=S(r,i,s,n,e[8],6,1873313359),n=S(n,r,i,s,e[15],10,-30611744),s=S(s,n,r,i,e[6],15,-1560198380),i=S(i,s,n,r,e[13],21,1309151649),r=S(r,i,s,n,e[4],6,-145523070),n=S(n,r,i,s,e[11],10,-1120210379),s=S(s,n,r,i,e[2],15,718787259),i=S(i,s,n,r,e[9],21,-343485551),t[0]=_(r,t[0]),t[1]=_(i,t[1]),t[2]=_(s,t[2]),t[3]=_(n,t[3])}function O(t){for(var e=[],r=0;r<64;r+=4)e[r>>2]=t.charCodeAt(r)+(t.charCodeAt(r+1)<<8)+(t.charCodeAt(r+2)<<16)+(t.charCodeAt(r+3)<<24);return e}function j(t,e,r,i,s,n){return e=_(_(e,t),_(i,n)),_(e<<s|e>>>32-s,r)}function P(t,e,r,i,s,n,a){return j(e&r|~e&i,t,e,s,n,a)}function I(t,e,r,i,s,n,a){return j(e&i|r&~i,t,e,s,n,a)}function A(t,e,r,i,s,n,a){return j(e^r^i,t,e,s,n,a)}function S(t,e,r,i,s,n,a){return j(r^(e|~i),t,e,s,n,a)}function _(t,e){return t+e&4294967295}var x=[4,3,5,6,1,2,8,7,2,9,3,5,7,1,4,8,8,3,4,3,1,7,3,5,9,8,1,4,3,7,2,8];function E(t){for(var e,r=b(/md5=(\w*)/g.exec(t)[1]+"secret"),i=r.length,s="",n=0,a=0;a<i;a++)n+=parseInt(r[a],16);for(var o=0;o<i;o++){var u=parseInt(r[o],16);e=o===i-1?u:parseInt(r[o+1],16),s+=Math.abs(n-u*e*x[o])}return t+"&client=web&clientHash="+s}var q=function(){this.listeners={}};q.prototype.on=function(t,e){var r=this.listeners[t];return r||(r=[],this.listeners[t]=r),r.push(e),this},q.prototype.emit=function(t,e){var r=this.listeners[t];r&&r.forEach(function(t){return t(e)})};var C=250,R=null;function N(){R&&clearTimeout(R)}var M,D="postroll";function U(e,r,i){return M?(M("user-skip"),Promise.resolve()):i?new Promise(function(s,n){M=n,new Promise(function(e,r){t(["adman"],e,r)}).then(function(t){return new t}).then(function(t){t.init(function(t,e){return{slot:3564,audioEl:t,params:{duration:e.duration,ok_id:e.userId,ok_catid:e.categoryId,puid22:e.genre,account_age_type:e.userType},wrapper:document.documentElement,browser:{}}}(e,i)),t.onReady(function(i){var n=t.getBannersForSection(D);n&&n.length?(!function(t){if(t&&t.settings&&t.settings[D]){var e=t.settings[D];e.maxBannersShow>1&&V("mbs"),e.loop&&V("loop")}}(i),e.loop&&(e.loop=!1),t.start(D),r.emit(7)):(V("skip"),s("skip"))}),t.onStarted(function(){V("started")}),t.onError(function(e){V("error"),t.stop(),r.emit(8),s(e)}),t.onTimeRemained(function(t){r.emit(9,{duration:t.duration,currentTime:t.currentTime})}),t.onCompleted(function(){r.emit(8),V("finished"),s()})}).catch(function(t){console.error("error while playing ads",t),r.emit(8),s()})}).then(function(){M=void 0}):Promise.resolve()}function L(t){switch(t){case 10:return"my";case 8:return"pop";case 14:return"personalpl";case 1:return"album";case 11:return"artist";default:return"unknown"}}function V(t){e.success("music.ads",t)}var H=function(t){function r(r){var i=this;t.call(this),this.audio=r,this.startTime=0,this.animateVolume=!1,this.lastVolume=this.audio.volume,this.audio.addEventListener("pause",function(){return i.emit(2)}),this.audio.addEventListener("play",function(){return i.emit(1)}),this.audio.addEventListener("waiting",function(){return i.emit(3,!0)}),this.audio.addEventListener("playing",function(){return i.emit(3,!1)}),this.audio.addEventListener("progress",function(){var t=i.getCached();t&&(i.startTime>0&&(e.duration("music",Date.now()-i.startTime,"player","cache-ttfb"),i.startTime=0),i.emit(4,{cached:t}))}),this.audio.addEventListener("suspend",function(){1===i.audio.networkState&&(i.getCached()/i.audio.duration>.9&&i.emit(4,{cached:i.audio.duration}))}),this.audio.addEventListener("timeupdate",function(){i.emit(5,{duration:i.audio.duration,currentTime:i.audio.currentTime})}),this.audio.addEventListener("ended",function(){i.emit(6)}),this.audio.addEventListener("error",function(){i.audio.src&&0!==i.audio.src.indexOf("data:audio/mpeg;base64")&&i.emit(0,i.audio.error)})}t&&(r.__proto__=t),r.prototype=Object.create(t&&t.prototype),r.prototype.constructor=r;var i={currentSrc:{configurable:!0},playing:{configurable:!0},currentTime:{configurable:!0},volume:{configurable:!0}};return i.currentSrc.get=function(){var t=this.audio.currentSrc;return 0===t.indexOf("data:audio")?"":t},i.playing.get=function(){return!this.audio.paused},i.currentTime.get=function(){return this.audio.currentTime},i.volume.get=function(){return this.audio.volume},i.volume.set=function(t){this.audio.volume=t/100},r.prototype.play=function(t,e){var r=this;this.restoreVolume(),e?U(this.audio,this,e).then(function(){return r.play0(t)}):this.play0(t)},r.prototype.pause=function(){var t,e,r;this.audio.paused||(this.animateVolume=!0,this.lastVolume=this.audio.volume,t=this.audio,e=Date.now(),r=function(){var i=Date.now();t.volume=Math.max(0,t.volume-(i-e)/C),e=i,t.volume>0?R=setTimeout(r,1):t.pause()},N(),r(),this.emit(2))},r.prototype.resume=function(){var t=this;return this.audio.paused?this.audio.src?this.play0().then(function(){var e,r,i,s;t.animateVolume&&(e=t.audio,r=t.lastVolume,i=Date.now(),s=function(){var t=Date.now();e.volume=Math.min(r,e.volume+(t-i)/C),i=t,e.volume<r&&(R=setTimeout(s,1))},N(),e.volume=0,s())}):Promise.reject("no-src"):Promise.resolve()},r.prototype.seek=function(t){this.restoreVolume(),this.audio.currentTime=t},r.prototype.play0=function(t){var e=this;t&&(this.startTime=Date.now(),this.audio.src=t);var r=this.audio.play();return r?r.then(function(){e.emit(1)}):(this.emit(1),Promise.resolve())},r.prototype.restoreVolume=function(){this.animateVolume&&(this.animateVolume=!1,this.audio.volume=this.lastVolume)},r.prototype.getCached=function(){var t=this.audio.buffered;return t.length?t.end(t.length-1):0},Object.defineProperties(r.prototype,i),r}(q),F=function(t){function r(){var r=this;t.call(this),this.obj=this.inject(),this.ready=!1,this.src="",this.currentVolume=100,this.currentTime=0,window.__handleMusicFlashEvent=function(t,i){switch(t){case"ready":r.ready=!0,r.volume=r.currentVolume;break;case"flash-error":e.success("music.flash.error",i.place);break;case"cached-updated":r.emit(4,{cached:i});break;case"time-updated":r.currentTime=i,r.emit(5,{currentTime:i});break;case"track-ended":r.emit(6)}}}t&&(r.__proto__=t),r.prototype=Object.create(t&&t.prototype),r.prototype.constructor=r;var i={currentSrc:{configurable:!0},playing:{configurable:!0},volume:{configurable:!0}};return i.currentSrc.get=function(){return this.src},i.playing.get=function(){try{return this.ready&&this.obj.isPlaying()}catch(t){return e.success("music.flash.error","isPlaying"),!1}},i.volume.get=function(){return this.currentVolume},i.volume.set=function(t){try{this.currentVolume=t,this.ready&&this.obj.setVolume(t)}catch(t){e.success("music.flash.error","setVolume")}},r.prototype.play=function(t){try{this.ready&&(this.src=t,this.obj.pplay(t),this.emit(1))}catch(t){e.success("music.flash.error","play")}},r.prototype.pause=function(){try{this.ready&&(this.obj.pause(),this.emit(2))}catch(t){e.success("music.flash.error","pause")}},r.prototype.resume=function(){try{return this.ready&&(this.obj.resume(),this.emit(1)),Promise.resolve()}catch(t){return e.success("music.flash.error","resume"),Promise.reject()}},r.prototype.seek=function(t){try{this.ready&&this.obj.seek(t)}catch(t){e.success("music.flash.error","seek")}},r.prototype.inject=function(){var t=document.createElement("div");return document.body.appendChild(t),t.innerHTML='<object type="application/x-shockwave-flash" id="ok-music-web" data="//st.mycdn.me/static/flash/1-0-0/audio.swf" width="1" height="1"><param name="menu" value="false"><param name="allownetworking" value="all"><param name="allowscriptaccess" value="always"></object>',t.firstChild},Object.defineProperties(r.prototype,i),r}(q),Q=!1,B="data:audio/mpeg;base64,/+MYxAAAAANIAAAAAExBTUUzLjk4LjIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";function W(t,e){try{return!!t.canPlayType&&"no"!==t.canPlayType(e)&&""!==t.canPlayType(e)}catch(t){return!1}}function J(e){new Promise(function(e,r){t(["adman"],e,r)}),window.addEventListener("click",function(){Q||e.src!==B||(Q=!0,e.play())},{once:!0})}function z(t){e.success("music","support",t)}var K={playing:!1,loading:!1,queue:{type:0,tracks:d.loading()},currentTime:0,duration:0,cached:0,volume:100,hasRadio:!1,muted:!1,repeat:"off",ad:!1},G=function(t){this.state=t||K,this.subscribers=[]},Y={playing:{configurable:!0},loading:{configurable:!0},track:{configurable:!0},user:{configurable:!0},queue:{configurable:!0},repeat:{configurable:!0},volume:{configurable:!0},currentTime:{configurable:!0},duration:{configurable:!0},cached:{configurable:!0},ad:{configurable:!0},muted:{configurable:!0},hasRadio:{configurable:!0}};function X(t){return t?t.duration:0}Y.playing.get=function(){return this.state.playing},Y.playing.set=function(t){this.state.playing!==t&&(this.state.playing=t,this.notify())},Y.loading.get=function(){return this.state.loading},Y.loading.set=function(t){this.state.loading!==t&&(this.state.loading=t,this.notify())},Y.track.get=function(){return this.state.track},Y.track.set=function(t){this.state.track=t,this.state.cached=-1,this.state.currentTime=-1,this.state.loading=!0,this.notify()},Y.user.get=function(){return this.state.user},Y.queue.get=function(){return this.state.queue},Y.queue.set=function(t){this.state.queue=t,this.notify()},Y.repeat.get=function(){return this.state.repeat},Y.volume.get=function(){return this.state.volume},Y.volume.set=function(t){this.state.volume=t,this.state.muted=!1,this.notify()},Y.currentTime.get=function(){return this.state.currentTime},Y.duration.get=function(){return this.state.currentTime},Y.cached.get=function(){return this.state.cached},Y.cached.set=function(t){-1!==this.state.cached&&(this.state.cached=t,this.notify())},Y.ad.get=function(){return this.state.ad},Y.ad.set=function(t){this.state.ad=t,this.notify()},Y.muted.get=function(){return this.state.muted},Y.muted.set=function(t){this.state.muted=t},Y.hasRadio.get=function(){return this.state.hasRadio},G.prototype.play=function(t,e,r){this.state.track=t,this.state.cached=0,this.state.currentTime=0,this.state.duration=X(t),this.state.user=e,this.state.hasRadio=r,this.state.ad=!1,this.notify()},G.prototype.updateTime=function(t){var e=t.currentTime,r=t.duration;-1!==this.state.currentTime&&(this.state.currentTime=e,this.state.duration=r||X(this.state.track),this.notify())},G.prototype.startAd=function(){this.state.ad=!0,this.state.playing=!0,this.notify()},G.prototype.updateAdTime=function(t){this.state.ad&&this.updateTime(t)},G.prototype.toggleRepeat=function(){this.state.repeat=function(t){switch(t){case"off":return"all";case"all":return"one";default:return"off"}}(this.state.repeat),this.notify()},G.prototype.rewind=function(){var t=this.state.queue.tracks.items[0];this.state.track=t,this.state.playing=!1,this.state.currentTime=0,this.state.cached=0,this.state.duration=X(t),this.notify()},G.prototype.setQueueLoading=function(t){this.queue0({tracks:this.queue.tracks.setLoading(t)})},G.prototype.updateQueue=function(t,e){this.state.track=t,this.state.queue=e,this.state.duration=X(t),this.state.currentTime=0,this.state.cached=0,this.notify()},G.prototype.addTrack=function(t){var e=this.state,r=e.track,i=e.queue;if(!r)return this.state.track=t,void(this.queue={tracks:d.of([t]),type:27,id:String(t.id)});if(i.tracks.isEmpty)this.queue={tracks:d.of([t]),type:27,id:String(t.id)};else{var s=i.tracks,n=s.items,a=i.originalTracks,o=n.indexOf(r);if(-1!==o){if(!a)return n.splice(o+1,0,t),void this.queue0({tracks:s.setItems(n)});n.splice(o+1,0,t),a.items.push(t),this.queue0({tracks:s.setItems(n)})}else this.queue0({tracks:s.setItems(n.concat([t]))})}},G.prototype.removeTrack=function(t){var e=this.state.queue.tracks,r=e.items.indexOf(t);if(r>-1){var i=e.items.slice();i.splice(r,1),this.queue.tracks=e.setItems(i)}},G.prototype.reorderTrack=function(t,e){var r=this.state.queue,i=r.tracks.items.slice(),s=i.indexOf(t);i.splice(s,1),i.splice(e,0,t),this.queue.tracks=r.tracks.setItems(i)},G.prototype.getCurrentIndex=function(){var t=this.state,e=t.track,r=t.queue;return e?r.tracks.items.indexOf(e):-1},G.prototype.subscribe=function(t){var e=this;return this.subscribers.push(t),t(this.state),function(){var r=e.subscribers.indexOf(t);r>=0&&e.subscribers.splice(r,1)}},G.prototype.queue0=function(t){this.queue=Object.assign(Object.assign({},this.state.queue),t)},G.prototype.notify=function(){var t=Object.assign({},this.state);this.subscribers.forEach(function(e){return e(t)})},Object.defineProperties(G.prototype,Y);var Z,$,tt,et="externalMusic",rt=(Z=window.navigator.userAgent,$=window.navigator.platform,-1!==["Macintosh","MacIntel","MacPPC","Mac68K"].indexOf($)?"Mac OS":-1!==["iPhone","iPad","iPod"].indexOf($)?"iOS":-1!==["Win32","Win64","Windows","WinCE"].indexOf($)?"Windows":/Android/.test(Z)?"Android":/Linux/.test($)?"Linux":void 0),it=!1;function st(t,r,i){r&&i&&(e.success(et,"listened",JSON.stringify(Object.assign(Object.assign({},i),{trackId:r.id,ctx:r.ctx,releaseId:r.releaseId,endReason:t,repeat:"off"===i.repeat?void 0:"one"===i.repeat?1:2,useDuration:Math.round((Date.now()-i.startTimestamp)/1e3),stateStart:i.stateStart?2:1,stateEnd:document.hasFocus()?2:1,addedDuringListening:it,previousUmaPayload:tt,osType:rt}))),tt=i.umaPayload,it=!1)}function nt(t){if(!t)return 0;if("string"==typeof t){if(!isNaN(t))return Number(t);switch(t){case"pop":return 8;case"album":return 1;case"artist":return 11;case"playlist":return 14;case"personal":return 10;case"friend":return 4}return 0}return t}function at(t,e){return e[0]&&!function(t,e){for(var r=t.items,i=0;i<r.length;i++){var s=r[i];if(ot(s,e[0])){for(var n=1;n<e.length;n++)if(!ot(s=r[i+n],e[n]))return!1;return!0}}return!1}(t,e)?d.of(e.concat(t.items),t.chunk,t.totalCount):t}function ot(t,e){return t===e||t.id===e.id}function ut(t){for(var e,r=t.slice(0),i=r.length-1;i>0;i--){var s=Math.floor(Math.random()*(i+1));e=[r[s],r[i]],r[i]=e[0],r[s]=e[1]}return r}var ct=function(t,e){this.store=t,this.fetcher=e};function pt(t,r,i,s){navigator.mediaSession&&(navigator.mediaSession.metadata=function(t){return new MediaMetadata({title:t.name,artist:t.artists.map(function(t){return t.name}).join(", "),album:t.album.name,artwork:t.cover?[{src:t.cover+"&fn=music.w_96",sizes:"96x96",type:"image/png"},{src:t.cover+"&fn=music.w_128",sizes:"128x128",type:"image/png"},{src:t.cover,sizes:"192x192",type:"image/png"}]:void 0})}(r),navigator.mediaSession.setActionHandler("play",function(){e.success("music.player","media-session","play"),t.resume()}),navigator.mediaSession.setActionHandler("pause",function(){e.success("music.player","media-session","pause"),t.pause()}),navigator.mediaSession.setActionHandler("seekbackward",function(){e.success("music.player","media-session","seekbackward"),t.seek(t.currentTime-10)}),navigator.mediaSession.setActionHandler("seekforward",function(){e.success("music.player","media-session","seekforward"),t.seek(t.currentTime+10)}),navigator.mediaSession.setActionHandler("previoustrack",function(){e.success("music.player","media-session","previoustrack"),s()}),navigator.mediaSession.setActionHandler("nexttrack",function(){e.success("music.player","media-session","nexttrack"),i()}))}ct.prototype.restore=function(t,e){var r=this;return 18!==t&&31!==t||(t=14),this.fetch({type:t,id:e}).catch(function(){return r.fetch({type:8})}).then(function(t){var e=t.tracks.items[0];r.store.updateQueue(e,t)})},ct.prototype.update=function(t){var e=this;return this.fetch(t).then(function(r){var i=t.track;if(t.preview&&(r.tracks=at(r.tracks,t.preview)),i)r.tracks=function(t,e){var r=t.items.findIndex(function(t){return e.id===t.id});return-1===r?t.items.splice(0,0,e):e!==t.items[r]&&(t.items[r]=e),t}(r.tracks,i);else if(!(i=r.tracks.items[0]))throw Promise.reject("ERROR_EMPTY");e.store.updateQueue(i,r)})},ct.prototype.loadMore=function(){var t=this,r=this.store.queue;return r.tracks.hasMore?(this.store.setQueueLoading(!0),this.fetcher.loadMore(r.type,r.id).then(function(e){t.store.queue=Object.assign(Object.assign({},r),{tracks:e})}).catch(function(){e.success("music.player.warn","load-more-"+r.type),t.store.queue=Object.assign(Object.assign({},r),{tracks:d.of(r.tracks.items,{start:r.tracks.chunk.start,count:r.tracks.chunk.count,more:!1})})})):Promise.reject("no-more-tracks")},ct.prototype.toggleShuffle=function(){var t,e,r,i=this.store,s=i.track,n=i.queue,a=n.type,o=n.id,u=n.originalTracks;this.store.queue=u?{type:a,id:o,tracks:u}:{id:o,type:a,tracks:(t=n.tracks,e=s,e?(r=ut(t.items.filter(function(t){return e.id!==t.id}))).unshift(e):r=ut(t.items),d.of(r,t.chunk,t.totalCount)),originalTracks:n.tracks}},ct.prototype.fetch=function(t){var r=this;return t.tracks?Promise.resolve({type:nt(t.type),id:t.id,tracks:Array.isArray(t.tracks)?d.of(t.tracks):t.tracks}):27===t.type&&t.track?Promise.resolve({type:27,id:t.id,tracks:d.of([t.track])}):t.type?this.fetchTracks(nt(t.type),t.id).catch(function(t){return e.success("music.player.warn",t,"queue-fetch"),r.fetchTracks(8)}).then(function(e){return t.tids?r.fetchTracks(-27,t.tids,t.ctx).then(function(r){var i=r.tracks;return t.preview=i.items,e}):e}):!t.tids||t.track&&t.tids===String(t.track.id)?t.track?Promise.resolve({type:0,tracks:d.of([t.track])}):Promise.reject("ERROR_EMPTY"):this.fetchTracks(-27,t.tids,t.ctx).then(function(t){return{type:0,tracks:t.tracks}})},ct.prototype.fetchTracks=function(t,e,r){return this.fetcher.fetchTracks(t,e,r).then(function(r){return{type:t,id:e,tracks:r}})};var lt=function(t){var r=this,i=t.userId,s=t.state,n=t.api,a=t.queueFetcher,o=t.chooseNextPlaylist;void 0===o&&(o=function(){return Promise.reject()}),this.userId=i,this.store=new G(s),this.api=n,this.queue=new ct(this.store,a),this.audio=function(){z("check");try{var t=new Audio(B);return W(t,"audio/mpeg")?(z("true"),J(t),new H(t)):W(t,"audio/mp3")?(z("true-mp3"),J(t),new H(t)):(z("false"),new F)}catch(t){return e.clob("music",t.message+"\n"+t.stack,"audio-support"),z("no-audio"),new F}}().on(1,function(){return r.store.playing=!0}).on(2,function(){return r.store.playing=!1}).on(3,function(t){return r.store.loading=t}).on(7,function(){return r.store.startAd()}).on(8,function(){return r.store.ad=!1}).on(9,function(t){return r.store.updateAdTime(t)}).on(5,function(t){return r.store.updateTime(t)}).on(4,function(t){var e=t.cached;return r.store.cached=e}).on(6,function(){var t=r.state,e=t.ad,i=t.repeat,s=t.track,n=t.queue;if(!e){if(st(4,s,r.logData),"off"!==i||n.tracks.items.indexOf(s)+1!==n.tracks.items.length)return"one"===i?(r.seek(0),void r.startPlay30Timer(s.id,s.ctx)):void r.playQueueItem(1).catch(function(){return r.rewind()});o(r.store.queue.type,r.store.queue.id).then(function(t){var e=t.type,i=t.id;return r.playQueue0(e,i)}).catch(function(){return r.rewind()})}}).on(0,function(t){e.success("music.player.error","audio",t.code),st(4,r.state.track,r.logData),r.store.playing=!1,r.store.loading=!1}),this.audio.volume=this.state.volume},dt={state:{configurable:!0}};dt.state.get=function(){return this.store},lt.prototype.subscribe=function(t){return this.store.subscribe(t)},lt.prototype.restore=function(t,e){return this.store.track?Promise.resolve():(8==t&&"2"==e&&(e=void 0),55!==t&&20!==t&&19!==t&&-26!==t||(t=8),this.queue.restore(t,e))},lt.prototype.play=function(t,e){var r=this;if(!t)return this.resume();var i=e?Array.isArray(e)?{tracks:e}:e:{};return st(3,this.state.track,this.logData),this.playTrack(t,i.ctx).then(function(t){var e=i.type,s=i.id,n=i.ctx;!e&&n&&0===n.indexOf("messaging")&&(i.type=27,i.id=t.id),8==e&&"2"==s&&(i.id=void 0),r.queue.update(Object.assign(Object.assign({},i),{track:t,id:i.id?String(i.id):void 0}))})},lt.prototype.playQueue=function(t,e,r){var i=e?String(e):void 0,s=this.state.queue;return t!==s.type||i!==s.id||this.state.playing?this.playQueue0(t,i,r):this.resume()},lt.prototype.pause=function(){this.audio.pause()},lt.prototype.setVolume=function(t){this.audio.volume=t,this.store.volume=t},lt.prototype.toggleMute=function(){this.state.muted?this.setVolume(this.state.volume||50):(this.audio.volume=0,this.store.muted=!0)},lt.prototype.prev=function(){return this.state.currentTime>10?(this.seek(0),Promise.resolve()):(st(2,this.state.track,this.logData),this.playQueueItem(-1))},lt.prototype.next=function(){return st(1,this.state.track,this.logData),this.playQueueItem(1)},lt.prototype.seek=function(t){this.resume(),this.audio.seek(t),this.store.updateTime({currentTime:t})},lt.prototype.toggleShuffle=function(){this.queue.toggleShuffle()},lt.prototype.toggleRepeat=function(){this.store.toggleRepeat()},lt.prototype.loadMoreTracks=function(){return this.state.queue.tracks.hasMore?this.queue.loadMore():Promise.resolve()},lt.prototype.addTrack=function(t){this.store.addTrack(t)},lt.prototype.removeTrack=function(t){this.state.track===t&&this.next(),this.store.removeTrack(t)},lt.prototype.reorderTrack=function(t,e){this.store.reorderTrack(t,e)},lt.prototype.resume=function(){var t=this;if(!this.audio.currentSrc){var e=this.state,r=e.track,i=e.queue;return r?this.playTrack(r).then(function(){return t.store.updateQueue(r,i)}):Promise.reject("no-track")}return this.audio.resume()},lt.prototype.playTrack=function(t,r){var i,s=this;return t?("object"!=typeof t?(i=Number(t),this.logData=void 0,this.store.loading=!0):(i=Number(t.id),r=r||t.ctx,this.logData=void 0,this.store.track=t),r||e.clob("music.player.warn",Error("[play] ctx is empty, track: "+JSON.stringify(t)).stack,"empty-ctx"),"friend_portlet"===r&&(e.success("music.player","ctx-fix","friend_portlet"),r="friend"),this.api.post("play",{tid:i,ctx:r}).then(function(e){var r=s.state.track;if("object"!=typeof t)t=m(e.track,e.albums[0]);else if(r&&r.id!==t.id)throw new Error("track-changed");return s.audio.play(E(e.play),function(t,e,r){if(r.commercial&&t)return{userId:t,categoryId:L(e),duration:r.track.duration,genre:r.commercialGenre,userType:r.commercialUserType}}(s.userId,s.state.queue.type,e)),s.store.play(t,e.friend,e.trackRadio),s.logData={umaPayload:e.umaPayload,startTimestamp:Date.now(),repeat:s.state.repeat,shuffle:!!s.state.queue.originalTracks,stateStart:document.hasFocus()},pt(s.audio,t,function(){return s.next()},function(){return s.prev()}),s.startPlay30Timer(t.id,t.ctx),t})):(e.clob("music.player.warn",Error("[play] tid is empty, track: "+JSON.stringify(t)).stack,"no-track"),Promise.reject())},lt.prototype.playQueue0=function(t,e,r){var i=this;return this.queue.update({type:t,id:e,ctx:r}).then(function(){i.playQueueItem(1,-1)})},lt.prototype.playQueueItem=function(t,r,i){var s=this;void 0===i&&(i=0);var n=this.state.queue.tracks,a=n.items,o=n.hasMore,u=n.loading,c=a.length;if(r=(void 0===r?this.store.getCurrentIndex():r)+t,o&&!u&&c-r<10&&0===i&&this.loadMoreTracks(),i>3)return Promise.reject();r>=c?r=0:r<0&&(r=o?0:c-1);var p=a[r];return this.playTrack(p).catch(function(n){if(e.success("music.player.error","play-track",n.message||n),"error.copyright.restriction"===n.message||"error.play.track.unplayable"===n.message)return s.playQueueItem(t,r,i+1);throw n})},lt.prototype.startPlay30Timer=function(t,e){var r=this;this.play30Timer&&clearTimeout(this.play30Timer),this.play30Timer=setTimeout(function(){return r.play30(t,e)},3e4)},lt.prototype.play30=function(t,e){this.api.post("play30",{tid:t,ctx:e,skipUmaLog:!0})},lt.prototype.rewind=function(){this.audio.pause(),this.store.rewind()},Object.defineProperties(lt.prototype,dt);var ht=function(t){var e,r=t.Symbol;return"function"==typeof r?r.observable?e=r.observable:(e=r("observable"),r.observable=e):e="@@observable",e}("undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof module?module:Function("return this")()),ft=function(){return Math.random().toString(36).substring(7).split("").join(".")},mt={INIT:"@@redux/INIT"+ft(),REPLACE:"@@redux/REPLACE"+ft(),PROBE_UNKNOWN_ACTION:function(){return"@@redux/PROBE_UNKNOWN_ACTION"+ft()}};function yt(t,e,r){var i;if("function"==typeof e&&"function"==typeof r||"function"==typeof r&&"function"==typeof arguments[3])throw new Error("It looks like you are passing several store enhancers to createStore(). This is not supported. Instead, compose them together to a single function.");if("function"==typeof e&&void 0===r&&(r=e,e=void 0),void 0!==r){if("function"!=typeof r)throw new Error("Expected the enhancer to be a function.");return r(yt)(t,e)}if("function"!=typeof t)throw new Error("Expected the reducer to be a function.");var s=t,n=e,a=[],o=a,u=!1;function c(){o===a&&(o=a.slice())}function p(){if(u)throw new Error("You may not call store.getState() while the reducer is executing. The reducer has already received the state as an argument. Pass it down from the top reducer instead of reading it from the store.");return n}function l(t){if("function"!=typeof t)throw new Error("Expected the listener to be a function.");if(u)throw new Error("You may not call store.subscribe() while the reducer is executing. If you would like to be notified after the store has been updated, subscribe from a component and invoke store.getState() in the callback to access the latest state. See https://redux.js.org/api-reference/store#subscribelistener for more details.");var e=!0;return c(),o.push(t),function(){if(e){if(u)throw new Error("You may not unsubscribe from a store listener while the reducer is executing. See https://redux.js.org/api-reference/store#subscribelistener for more details.");e=!1,c();var r=o.indexOf(t);o.splice(r,1),a=null}}}function d(t){if(!function(t){if("object"!=typeof t||null===t)return!1;for(var e=t;null!==Object.getPrototypeOf(e);)e=Object.getPrototypeOf(e);return Object.getPrototypeOf(t)===e}(t))throw new Error("Actions must be plain objects. Use custom middleware for async actions.");if(void 0===t.type)throw new Error('Actions may not have an undefined "type" property. Have you misspelled a constant?');if(u)throw new Error("Reducers may not dispatch actions.");try{u=!0,n=s(n,t)}finally{u=!1}for(var e=a=o,r=0;r<e.length;r++){(0,e[r])()}return t}return d({type:mt.INIT}),(i={dispatch:d,subscribe:l,getState:p,replaceReducer:function(t){if("function"!=typeof t)throw new Error("Expected the nextReducer to be a function.");s=t,d({type:mt.REPLACE})}})[ht]=function(){var t,e=l;return(t={subscribe:function(t){if("object"!=typeof t||null===t)throw new TypeError("Expected the observer to be an object.");function r(){t.next&&t.next(p())}return r(),{unsubscribe:e(r)}}})[ht]=function(){return this},t},i}function gt(t,e){var r=e&&e.type;return"Given "+(r&&'action "'+String(r)+'"'||"an action")+', reducer "'+t+'" returned undefined. To ignore an action, you must explicitly return the previous state. If you want this reducer to hold no value, you can return null instead of undefined.'}function kt(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}function vt(t,e){var r=Object.keys(t);return Object.getOwnPropertySymbols&&r.push.apply(r,Object.getOwnPropertySymbols(t)),e&&(r=r.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r}function bt(t){for(var e=arguments,r=1;r<arguments.length;r++){var i=null!=e[r]?e[r]:{};r%2?vt(i,!0).forEach(function(e){kt(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):vt(i).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}function wt(){for(var t=arguments,e=arguments.length,r=new Array(e),i=0;i<e;i++)r[i]=t[i];return 0===r.length?function(t){return t}:1===r.length?r[0]:r.reduce(function(t,e){return function(){return t(e.apply(void 0,arguments))}})}function Tt(t,e){if(e){var r=Object.assign({},t);return e.forEach(function(t){var e=r[t.id];r[t.id]=Object.assign(Object.assign({},e),{playlist:Object.assign(Object.assign(Object.assign({},null==e?void 0:e.playlist),{bookmarked:!1}),t),tracks:e&&e.tracks||d.empty(t.count),favourite:!0})}),r}return t}function Ot(t,e){switch(e.type){case"tracks/set_tracks_loading":return function(t,e){return Object.assign(Object.assign({},t),{tracks:(t.tracks||d.empty()).setLoading(e)})}(t,e.loading);case"tracks/set_tracks":return function(t,e){return Object.assign(Object.assign({},t),{playlist:{id:e.id,name:e.name,playCount:e.playCount,subscribers:e.subscribers,images:e.images,editable:e.editable,bookmarked:e.bookmarked,importing:e.importing,newTracksCount:e.newTracksCount,playlistId:e.playlistId},favourite:e.favourite,owner:e.owner,groupOwner:e.groupOwner,playlists:e.playlists||t.playlists,subscribed:e.subscribed,tracks:t.tracks.add(y(e.tracks,e.albums),e.chunk,e.totalTracks),similarTracks:e.extension?d.of(y(e.extension,e.albums),{more:!0}):t.similarTracks})}(t,e.data);case"tracks/add_similar_tracks":return function(t,e){if(!e.tracks)return t;if(t.similarTracks){var r=function(t,e){return t.filter(function(t){var r=e.has(t.id);return!r&&(e.add(t.id),!0)})}(y(e.tracks,e.albums),function(t){return new Set(t.map(function(t){return t.id}))}(t.similarTracks.items));return Object.assign(Object.assign({},t),{similarTracks:It(t.similarTracks.items.concat(r),r.length>0)})}return Object.assign(Object.assign({},t),{similarTracks:It(y(e.tracks,e.albums),!0)})}(t,e.data);case"tracks/add_tracks":return function(t,e,r,i){void 0===e&&(e=[]);var s=!1;if(Pt(t.tracks)){var n=new Set(e.map(function(t){return t.id})),a=t.tracks.items.filter(function(t){return!n.has(t.id)}),o=t.tracks.totalCount;e=e.map(function(t){return Object.assign({},t)}),t.tracks=d.of(e.concat(a),t.tracks.chunk,i||(o?o-1:o)),s=!0}r&&(t.playlist=Object.assign(Object.assign({},t.playlist),{images:r||t.playlist.images}),s=!0);return s?Object.assign({},t):t}(t,e.tracks,e.images,e.totalTracks);case"tracks/remove_track":return function(t,e){if(t.tracks){var r=t.tracks.items.findIndex(function(t){return t.id===e});if(r>-1){var i=t.tracks.items.slice(),s=t.tracks.totalCount;return i.splice(r,1),Object.assign(Object.assign({},t),{tracks:d.of(i,t.tracks.chunk,s?s-1:s)})}}return t}(t,e.tid);case"tracks/replace_track":return function(t,e,r){var i=t.tracks.items,s=i.findIndex(function(t){return t.id===e});if(s>-1)return i[s]=r,Object.assign(Object.assign({},t),{tracks:t.tracks.setItems([].concat(i))});return t}(t,e.tid,e.track);case"tracks/mark_track_as_removed":return function(t,e){var r=t.tracks.totalCount;return Object.assign(Object.assign({},t),{removed:jt(t.removed,e),tracks:t.tracks.setTotalCount(r?r-1:r)})}(t,e.tid);case"tracks/remove_marked_tracks":return function(t){if(t.removed&&t.tracks)return Object.assign(Object.assign({},t),{tracks:t.tracks.setItems(t.tracks.items.filter(function(e){return!t.removed.has(e.id)})),removed:void 0});return t}(t);case"tracks/reorder_tracks":return function(t,e,r){if(t.tracks){var i=t.tracks.items.slice(),s=i.splice(e,1)[0];return i.splice(r,0,s),Object.assign(Object.assign({},t),{tracks:t.tracks.setItems(i)})}return t}(t,e.from,e.to);case"tracks/restore_track":return function(t,e){if(t.removed&&t.removed.delete(e)){var r=t.tracks.totalCount;return Object.assign(Object.assign({},t),{tracks:t.tracks.setTotalCount(r?r+1:r),removed:new Set(Array.from(t.removed))})}return t}(t,e.tid);case"tracks/add_uploaded_tracks":return function(t,e){void 0===e&&(e=[]);if(Pt(t.tracks)){var r=new Set(e.map(function(t){return t.id})),i=t.tracks.items.filter(function(t){return!r.has(t.id)});return Object.assign(Object.assign({},t),{tracks:d.of(e.concat(i),t.tracks.chunk,(t.tracks.totalCount||0)+e.length)})}return t}(t,e.tracks);case"tracks/create_playlist":case"tracks/update_all_playlists":return function(t,e){void 0===e&&(e=[]);return Object.assign(Object.assign({},t),{playlists:e})}(t,e.playlists);case"tracks/update_playlist":return function(t,e,r){return Object.assign(Object.assign({},t),{playlists:(t.playlists||[]).map(function(t){return t.id===e?Object.assign(Object.assign({},t),r):t})})}(t,e.pid,e.playlist)}return t}function jt(t,e){if(!t)return new Set([e]);var r=Array.from(t);return r.push(e),new Set(r)}function Pt(t){return t.isNotEmpty||!t.hasMore}function It(t,e){return d.of(t,{more:e})}function At(t,e,r){var i=t.get(e);return i?(t.set(e,Object.assign(Object.assign({},i),r)),new Map(t)):t}var St={tracks:d.empty()},_t=function(t){for(var e=Object.keys(t),r={},i=0;i<e.length;i++){var s=e[i];"function"==typeof t[s]&&(r[s]=t[s])}var n,a=Object.keys(r);try{!function(t){Object.keys(t).forEach(function(e){var r=t[e];if(void 0===r(void 0,{type:mt.INIT}))throw new Error('Reducer "'+e+"\" returned undefined during initialization. If the state passed to the reducer is undefined, you must explicitly return the initial state. The initial state may not be undefined. If you don't want to set a value for this reducer, you can use null instead of undefined.");if(void 0===r(void 0,{type:mt.PROBE_UNKNOWN_ACTION()}))throw new Error('Reducer "'+e+"\" returned undefined when probed with a random type. Don't try to handle "+mt.INIT+' or other actions in "redux/*" namespace. They are considered private. Instead, you must return the current state for any unknown actions, unless it is undefined, in which case you must return the initial state, regardless of the action type. The initial state may not be undefined, but can be null.')})}(r)}catch(t){n=t}return function(t,e){if(void 0===t&&(t={}),n)throw n;for(var i=!1,s={},o=0;o<a.length;o++){var u=a[o],c=r[u],p=t[u],l=c(p,e);if(void 0===l){var d=gt(u,e);throw new Error(d)}s[u]=l,i=i||l!==p}return(i=i||a.length!==Object.keys(t).length)?s:t}}({currentUser:function(t,e){switch(void 0===t&&(t={id:"0"}),e.type){case"app/init":return r=String(e.userId),i=e.featuredPlaylist,s=e.subscribed,{id:r,hasFeatured:i,subscribed:s};case"current_user/update_subscription_status":return function(t,e){return Object.assign(Object.assign({},t),{subscribed:e})}(t,e.subscribed);default:return t}var r,i,s},playlists:Et(function(t,e){switch(e.type){case"tracks/update_all_playlists":return Tt(t,e.playlists);case"tracks/create_playlist":return function(t,e,r,i){var s=Tt(t,r);return s[e]&&(s[e].editable=!0,s[e].playlist=Object.assign(Object.assign({},s[e].playlist),{editable:!0}),s[e].tracks=d.of(i,{start:0,count:i.length,more:!1})),s}(t,e.newPlaylistId,e.playlists,e.tracks);case"tracks/update_playlist":case"playlists/update":return function(t,e,r){var i;return t[e]?Object.assign(Object.assign({},t),((i={})[e]=Object.assign(Object.assign({},t[e]),{playlist:Object.assign(Object.assign({},t[e].playlist),r)}),i)):t}(t,e.pid,e.playlist)}return t},xt("playlists")),users:Et(function(t,e){var r,i;if("app/init"===e.type){var s=t[e.userId]||{},n=f(e.playlists);return Object.assign(Object.assign({},t),((r={})[e.userId]={tracks:s.tracks?s.tracks.setTotalCount(e.totalTracks):d.empty(e.totalTracks),playlists:null===(i=e.myPlaylists)||void 0===i?void 0:i.map(function(t){return n[t]})},r))}return t},xt("users")),groups:xt("groups"),collections:xt("collections"),player:function(t,e){return void 0===t&&(t=K),"app/restore"===e.type?Object.assign(Object.assign({},t),e.player):"player/update"===e.type?e.state:t},uploads:function(t,e){switch(void 0===t&&(t=new Map),e.type){case"upload/append":return function(t,e){return e.forEach(function(e){return t.set(e.cid,e)}),new Map(t)}(t,e.uploads);case"upload/set_id":return function(t,e,r){return At(t,e,{uploadId:r})}(t,e.cid,e.uploadId);case"upload/set_progress":return function(t,e,r){return At(t,e,{progress:r})}(t,e.cid,e.progress);case"upload/finish":return function(t,e){return At(t,e,{status:"uploaded"})}(t,e.cid);case"upload/set_error":return function(t,e,r){return At(t,e,{status:"failed",error:r})}(t,e.cid,e.error);case"upload/reset":return function(t,e){return At(t,e,{status:"uploading",error:void 0})}(t,e.cid);case"upload/remove":return function(t,e){return t.delete(e)?new Map(t):t}(t,e.cid)}return t}});function xt(t){return function(e,r){var i;if(void 0===e&&(e={}),r.id&&r.branch===t){var s=e[r.id]||St,n=Ot(s,r);if(n!==s)return Object.assign(Object.assign({},e),((i={})[r.id]=n,i))}return e}}function Et(){for(var t=[],e=arguments.length;e--;)t[e]=arguments[e];return function(e,r){void 0===e&&(e={});for(var i=0,s=t;i<s.length;i+=1){var n=(0,s[i])(e,r);if(n!==e)return n}return e}}function qt(t){var e=yt(_t,function(t){return{currentUser:{id:t}}}(t),function(){for(var t=arguments,e=arguments.length,r=new Array(e),i=0;i<e;i++)r[i]=t[i];return function(t){return function(){var e=t.apply(void 0,arguments),i=function(){throw new Error("Dispatching while constructing your middleware is not allowed. Other middleware would not be applied to this dispatch.")},s={getState:e.getState,dispatch:function(){return i.apply(void 0,arguments)}},n=r.map(function(t){return t(s)});return bt({},e,{dispatch:i=wt.apply(void 0,n)(e.dispatch)})}}}(Rt));return function(t){try{var e=t.getState().currentUser.id,r=localStorage.getItem(Nt(e));r&&t.dispatch(Object.assign({type:"app/restore"},JSON.parse(r)))}catch(t){}}(e),e}function Ct(t){return function(e){var r=t.getState(),i=r.currentUser,s=r.player;t.dispatch({type:"player/update",state:e}),function(t,e,r){try{(function(t,e){return t.volume!==e.volume||t.repeat!==e.repeat})(e,r)&&localStorage.setItem(t,function(t){return JSON.stringify({player:t})}(e))}catch(t){}}(Nt(i.id),e,s)}}function Rt(){return function(t){return function(r){try{return t(r)}catch(t){throw e.clob("music.reducer.error",t.stack,r.type),t}}}}function Nt(t){return t+"_music-state"}function Mt(t,e,r,i){var s,n=arguments.length,a=n<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,i);else for(var o=t.length-1;o>=0;o--)(s=t[o])&&(a=(n<3?s(a):n>3?s(e,r,a):s(e,r))||a);return n>3&&a&&Object.defineProperty(e,r,a),a}function Dt(t,e,r){var i=r.value,s={};return r.value=function(){var t=arguments[0];return s[t]||(s[t]=i.apply(this,arguments)),s[t]},r}var Ut=function(t){this.api=t};Ut.prototype.fetch=function(t,e){return this.api.get("album",{albumId:t,ctx:e}).then(function(t){var e=t.album,r=t.tracks,i=t.albums;return{album:e,tracks:d.of(g(r,e)),albums:i}})},Ut.prototype.fetchTracks=function(t,e){return this.fetch(t,e).then(function(t){return t.tracks})},Mt([Dt],Ut.prototype,"fetch",null);var Lt=function(t){this.api=t};Lt.prototype.fetch=function(t,e){return this.api.get("artist",{artistId:t,sts:100,mvs:100,ctx:e}).then(function(t){var e=t.artist,r=t.tracks,i=t.albums,s=t.masterAlbums,n=t.collaborations,a=t.similarArtists,o=t.movies,u=t.similarTracks;return{artist:e,tracks:d.of(y(r,i)),similarTracks:d.of(y(u||[],i),{more:!0}),albums:s,collaborations:n,similarArtists:a,videos:o}})},Lt.prototype.fetchTracks=function(t,e){return this.fetch(t,e).then(function(t){return t.tracks})},Lt.prototype.loadSimilarTracks=function(t){return Promise.all([this.fetch(t),this.api.get("similarTracksForArtist",{artistId:t,count:100})]).then(function(t){var e=t[0],r=t[1],i=function(t){var e=new Set;return t.similarTracks.items.forEach(function(t){return e.add(t.id)}),e}(e),s=y(r.tracks||[],r.albums).filter(function(t){return!i.has(t.id)}),n=e.similarTracks.items.concat(s);return e.similarTracks=d.of(n,{more:s.length>0}),e.similarTracks})},Lt.prototype.fetchSimilarTracks=function(t){return this.fetch(t).then(function(t){return t.similarTracks})},Mt([Dt],Lt.prototype,"fetch",null);var Vt={tracks:d.empty(),similarTracks:d.empty()},Ht=function(t,e,r){this.branch=t,this.store=e,this.api=r};Ht.prototype.getTracks=function(t){return this.get(t).tracks||d.empty()},Ht.prototype.fetchTracks=function(t,e){var r=this.getTracks(t);return r.isNotEmpty||!r.hasMore?Promise.resolve(r):this.loadTracks(t,e)},Ht.prototype.loadTracks=function(t,e){var r=this;this.dispatch(t,"tracks/set_tracks_loading",{loading:!0});var i=this.getTracks(t),s=i.from;return this.request(t,s>0?i.items[0].ctx:e,s).then(function(e){return r.dispatch(t,"tracks/set_tracks",{data:e}),r.getTracks(t)}).catch(function(e){throw r.dispatch(t,"tracks/set_tracks_loading",{loading:!1}),e})},Ht.prototype.fetchSimilarTracks=function(t){var e=this.get(t).similarTracks||d.empty();return e.isNotEmpty||!e.hasMore?Promise.resolve(e):this.loadSimilarTracks(t)},Ht.prototype.loadSimilarTracks=function(t){var e=this;return this.requestSimilarTracks(t).then(function(r){return e.dispatch(t,"tracks/add_similar_tracks",{data:r}),e.get(t).similarTracks})},Ht.prototype.editTrack=function(t,e,r,i,s){var n=this;return this.api.post("edit",{tid:e,pid:"playlists"===this.branch?t:void 0,groupId:"groups"===this.branch?t:void 0,tit:r,art:i,alb:s}).then(function(r){var i=r.edited,a=m(i,{id:i.albumId,name:s});return n.dispatch(t,"tracks/replace_track",{tid:e,track:a}),a})},Ht.prototype.removeTrack=function(t,e){return this.dispatch(t,"tracks/remove_track",{tid:e}),this.api.post("dislike",{pid:"playlists"===this.branch?t:void 0,groupId:"groups"===this.branch?t:void 0,tid:e})},Ht.prototype.restoreTrack=function(t,e){var r=this.get(t).tracks.items.findIndex(function(t){return t.id===e});return this.dispatch(t,"tracks/restore_track",{tid:e}),this.api.post("like",{pid:"playlists"===this.branch?t:void 0,groupId:"groups"===this.branch?t:void 0,tid:e,pos:r})},Ht.prototype.reorderTracks=function(t,e,r,i){var s=this.get(t),n=Math.min(s.tracks.totalCount,i);return this.dispatch(t,"tracks/reorder_tracks",{from:r,to:n}),this.api.post("reorder",{tid:e,pid:"playlists"===this.branch?t:void 0,groupId:"groups"===this.branch?t:void 0,pos:n})},Ht.prototype.markTrackAsRemoved=function(t,e){return this.dispatch(t,"tracks/mark_track_as_removed",{tid:e}),this.api.post("dislike",{pid:"playlists"===this.branch?t:void 0,groupId:"groups"===this.branch?t:void 0,tid:e})},Ht.prototype.clearRemovedTracks=function(t){this.dispatch(t,"tracks/mark_track_as_removed")},Ht.prototype.requestSimilarTracks=function(t){return this.api.get("similarTracksForPlaylist",{pid:t,count:100})},Ht.prototype.createPlaylist=function(t,e,r){var i=this;return this.api.post("playlistsAdd",{name:e,tid:r.map(function(t){return t.id}).reverse().join(","),publicPlaylist:!0,groupId:"groups"===this.branch?t:void 0}).then(function(e){var s=e.newPlaylistId;return i.dispatch(t,"tracks/create_playlist",{playlists:e.playlists,newPlaylistId:e.newPlaylistId,tracks:r}),s})},Ht.prototype.addPlaylist=function(t,e){return this.patchPlaylist(t,e,"playlistsAdd",{pid:e})},Ht.prototype.removePlaylist=function(t,e){return this.patchPlaylist(t,e,"playlistsRemove",{pid:e})},Ht.prototype.patchPlaylist=function(t,e,r,i){var s=this;return this.api.post(r,Object.assign({pid:e,groupId:"groups"===this.branch?t:void 0},i)).then(function(e){return s.updateAllPlaylists(t,e.playlists)})},Ht.prototype.updateAllPlaylists=function(t,e){return this.dispatch(t,"tracks/update_all_playlists",{playlists:e}),e},Ht.prototype.get=function(t){return this.store.getState()[this.branch][t]||Vt},Ht.prototype.request=function(t,e,r){return this.api.get("my",{pid:t,ctx:e,start:r,count:100,extCount:r?0:18})},Ht.prototype.dispatch=function(t,e,r){this.store.dispatch(Object.assign({type:e,id:String(t),branch:this.branch},r))};var Ft=function(t,e){this.api=t,this.playlists=e};Ft.prototype.getAll=function(t,e){return this.api.get("imagesV2",{pid:t,count:e})},Ft.prototype.update=function(t,e){var r=this.playlists.getPlaylist(t);this.playlists.update(t,{images:{imageId:e.id,imageUrl:e.url,imageCounter:r.images.imageCounter}})},Ft.prototype.save=function(t,e){return this.playlists.modify(t,"playlistsSet",{imageIds:e})},Ft.prototype.upload=function(t,e){var r=this,i=URL.createObjectURL(e);return this.update(t,{id:0,url:i}),this.api.post("requestImageUpload").then(function(t){var i=t.url;return r.upload0(i,e)}).then(function(e){var i=e.imageId;return r.save(t,i)}).catch(function(t){throw URL.revokeObjectURL(i),t})},Ft.prototype.upload0=function(t,e){var r=new FormData;return r.append("file",e),this.api.post(t,r)};var Qt=function(t){function e(e,r,i,s){t.call(this,"playlists",e,r),this.images=new Ft(r,this),this.library=i,this.groups=s}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.getPlaylist=function(e){return t.prototype.get.call(this,e).playlist},e.prototype.create=function(t,e,r,i){var s=this,n=i?this.groups.createPlaylist(i,t,e):this.library.createPlaylist(t,e);return n.then(function(t){return r&&s.images.upload(t,r),s.loadSimilarTracks(t),t})},e.prototype.changeName=function(t,e){var r=this,i=this.store.getState().playlists[t].playlist;return this.update(t,{name:e}),this.modify(t,"playlistsSet",{name:e}).catch(function(e){throw r.update(t,{name:i.name}),e})},e.prototype.modify=function(t,e,r){var i=this,s=this.store.getState().playlists[t];return this.api.post(e,Object.assign({pid:t},r)).then(function(t){var e,r=t.playlists,n=null===(e=null==s?void 0:s.groupOwner)||void 0===e?void 0:e.id;return n?i.groups.updateAllPlaylists(n,r):i.library.updateAllPlaylists(r)})},e.prototype.update=function(t,e){this.store.dispatch({type:"playlists/update",pid:t,playlist:e})},e.prototype.request=function(t,e,r){return this.api.get("my",{pid:t,ctx:e,start:r,count:100,extCount:r?0:18})},e}(Ht),Bt=function(t){function e(e,r){t.call(this,"users",e,r)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.request=function(t,e,r){return this.api.get("my",{uid:t===this.store.getState().currentUser.id?void 0:t,ctx:e,start:r,count:100,extCount:r?0:18})},e}(Ht),Wt=function(t){function e(e,r){t.call(this,"groups",e,r)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.join=function(t){return this.api.post("joinGroup",{groupId:t})},e.prototype.loadRecommended=function(t){return this.api.get("recommendGroups",{count:3,marker:t}).then(function(t){var e=f(t.groups);return{groups:t.items.map(function(t){var r=t.groupRef,i=t.description,s=r.split(":")[1];return Object.assign(Object.assign({},e[s]),{description:i})}),marker:t.marker}})},e.prototype.request=function(t,e,r){void 0===r&&(r=0);var i=this.get(t),s={groupId:t,ctx:e,start:r,count:100};return r>0?this.api.get("group",s).then(function(e){return{id:Number(t),name:i.groupOwner.name,groupOwner:i.groupOwner,playCount:i.playlist.playCount,subscribed:i.subscribed,editable:i.editable,totalTracks:i.tracks.totalCount,subscribers:i.playlist.subscribers,albums:e.albums,tracks:e.tracks,chunk:e.chunk,playlists:i.playlists}}):this.api.get("group",s).then(function(t){return{id:t.groupId,name:t.name,playCount:0,subscribed:t.subscribed,editable:t.editable,totalTracks:t.totalTracks,subscribers:{count:t.membersCount,friendsCount:t.friendsCount,friends:t.friendsFull},albums:t.albums,tracks:t.tracks,chunk:t.chunk,playlists:t.playlists,groupOwner:{id:String(t.groupId),name:t.name,imageUrl:t.image}}})},e}(Ht),Jt=function(t){function e(e,r){t.call(this,"collections",e,r)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.fetchSet=function(t){return this.api.get("collections",{shortName:t,tracksPreview:!0}).then(function(t){var e=t.title,r=t.collections,i=t.albums;return{name:e,collections:r.map(function(t){return Object.assign(Object.assign({},t),{tracksPreview:y(t.tracksPreview,i)})})}})},e.prototype.fetchRecommended=function(){return this.api.get("collections",{editorial:!0})},e.prototype.request=function(t,e,r){return void 0===r&&(r=0),this.api.get("collection",{collectionId:t,ctx:e,start:r,count:100}).then(function(t){var e=t.collection,r=t.tracks,i=t.albums,s=t.chunk;return{id:e.id,name:e.name,playCount:e.playCount,subscribers:e.subscribers,playlistId:e.playlistId,images:{imageCounter:1,imageId:0,imageUrl:e.image},totalTracks:e.count,editable:!1,tracks:r,albums:i,chunk:s}})},e}(Ht);Mt([Dt],Jt.prototype,"fetchSet",null),Mt([Dt],Jt.prototype,"fetchRecommended",null);var zt=function(t){this.api=t};zt.prototype.share=function(t,e,r){return"track"===t?this.api.post("postStatus",{songId:e}):this.api.post("postPlaylist",{id:e,type:t,pId:r})};var Kt=function(t,e,r){this.store=t,this.api=e,this.users=r},Gt={userId:{configurable:!0}};Gt.userId.get=function(){return this.store.getState().currentUser.id},Kt.prototype.updatePlaylists=function(){var t=this;return this.api.get("playlistsGet").then(function(e){return t.updateAllPlaylists(e.playlists)})},Kt.prototype.loadExternal=function(t,e){return this.api.get("getExternalPlaylists",{socialProvider:"VK",redirect_uri:e,authCode:t})},Kt.prototype.importExternalPlaylists=function(t,e){var r=this;return this.api.post("importExternalPlaylists",{statusId:t,payloads:e.join(",")}).then(function(t){return r.users.updateAllPlaylists(r.userId,t.playlists)})},Kt.prototype.getTracks=function(){return this.users.getTracks(this.userId)},Kt.prototype.loadTracks=function(){return this.users.loadTracks(this.userId)},Kt.prototype.fetchTracks=function(){return this.users.fetchTracks(this.userId)},Kt.prototype.fetchSimilarTracks=function(){return this.users.fetchSimilarTracks(this.userId)},Kt.prototype.loadSimilarTracks=function(){return this.users.loadSimilarTracks(this.userId)},Kt.prototype.loadHistory=function(t,e){return void 0===t&&(t=0),void 0===e&&(e=100),this.load0("history",t,e).then(function(t){var e=t.history,r=t.tracks,i=t.albums,s=t.chunk;return e&&r?d.of(function(t,e,r){for(var i=[],s=f(r),n=f(e),a=0,o=t;a<o.length;a+=1){var u=o[a],c=n[u.id];c&&i.push({track:m(c,s[c.albumId]),added:u.added})}return i}(e,r,i),s):d.of([])})},Kt.prototype.clearHistory=function(){return this.api.post("clearHistory")},Kt.prototype.loadDownloads=function(t,e){return void 0===t&&(t=0),void 0===e&&(e=100),this.load0("downloaded",t,e).then(function(t){var e=t.tracks,r=t.albums,i=t.chunk;return e?d.of(y(e,r),i):d.of([])})},Kt.prototype.editTrack=function(t,e,r,i){return this.users.editTrack(this.userId,t,e,r,i)},Kt.prototype.removeTrack=function(t){return this.users.removeTrack(this.userId,t)},Kt.prototype.restoreTrack=function(t){return this.users.restoreTrack(this.userId,t)},Kt.prototype.markTrackAsRemoved=function(t){return this.users.markTrackAsRemoved(this.userId,t)},Kt.prototype.clearRemovedTracks=function(){this.users.clearRemovedTracks(this.userId)},Kt.prototype.reorderTracks=function(t,e,r){return this.users.reorderTracks(this.userId,t,e,r)},Kt.prototype.createPlaylist=function(t,e){return this.users.createPlaylist(this.userId,t,e)},Kt.prototype.removePlaylist=function(t){return this.users.removePlaylist(this.userId,t)},Kt.prototype.addPlaylist=function(t){return this.users.addPlaylist(this.userId,t)},Kt.prototype.addPlaylistBookmark=function(t){return this.users.patchPlaylist(this.userId,t,"playlistsBookmarkAdd")},Kt.prototype.removePlaylistBookmark=function(t){return this.users.patchPlaylist(this.userId,t,"playlistsBookmarkRemove",{pid:t})},Kt.prototype.updateAllPlaylists=function(t){return this.users.updateAllPlaylists(this.userId,t)},Kt.prototype.markPlaylistAsRead=function(t){this.store.dispatch({type:"tracks/update_playlist",id:this.userId,pid:t,playlist:{newTracksCount:0}})},Kt.prototype.load0=function(t,e,r){return void 0===e&&(e=0),void 0===r&&(r=100),this.api.get(t,{start:e,count:r})},Object.defineProperties(Kt.prototype,Gt);var Yt=function(t){this.api=t};Yt.prototype.fetch=function(){return this.api.get("myTuners").then(function(t){return t.tuners})},Yt.prototype.loadTracks=function(t){return this.api.get("myRadio",{tuner:t,count:300}).then(function(t){var e=t.tracks,r=t.albums;return d.of(y(e,r))})},Mt([Dt],Yt.prototype,"fetch",null);var Xt={query:"",counts:{},results:d.empty()},Zt=function(t){this.api=t};function $t(t,e){switch(t){case"tracks":var r=e;return y(r.tracks,r.albums);case"artists":return e.artists;case"albums":return e.albums;case"playlists":return e.playlists;default:return[]}}Zt.prototype.loadSuggests=function(t,e){void 0===e&&(e=6);var r=t.trim();return r?this.api.get("suggest",{q:r,count:e}):Promise.resolve({})},Zt.prototype.loadRelevant=function(t,e,r,i){var s=e.trim();return s?this.api.get("relevant",{tabName:t,q:s,artistName:r,count:100,bmtc:3,submitted:i}).then(function(e){var r,i,n=function(t,e,r){switch(t){case"tracks":var i=e;return i.tracks?y(i.tracks,r):[];case"artists":return e.artists||[];case"albums":return e.albums||[];case"playlists":return e.playlists||[];default:return[]}}(t,e.section,e.albums);return{query:s,bestMatch:e.bestMatch&&(r=e.bestMatch,i=e.albums,{album:r.album,artist:r.artist,tracks:y(r.tracksPreview,i)}),counts:e.relevantCounts,results:d.of(n,e.section.chunk)}}):Promise.resolve(Xt)},Zt.prototype.loadResults=function(t,e,r,i){void 0===r&&(r=0),void 0===i&&(i=100);var s=e.trim();return s?this.api.get(t,{q:s,start:r,count:i}).then(function(e){return{query:s,counts:e.relevantCounts,results:d.of($t(t,e),e.chunk)}}):Promise.resolve(Xt)},Zt.prototype.loadHistory=function(){return this.api.get("searchHistory")},Zt.prototype.removeQueryFromHistory=function(t){return this.api.get("removeSearchHistory",{query:t})};var te=function(t){this.api=t};te.prototype.load=function(t){var e=this;return this.api.get("pop",{layout:!0,start:t||void 0,etag:!t&&this.state&&this.etag}).then(function(r){var i=r.blocks?function(t,e){return t.map(function(t){return function(t){return"history"===t.type||"similar_playlist_tracks"===t.type||"similar_artist_tracks"===t.type}(t)?{type:t.type,header:t.header,content:{tracks:y(t.content.tracks,e)}}:"top_tracks_list"===t.type?{type:t.type,header:t.header,content:{tuners:t.content.tuners,selected:"all",tracks:{all:d.of(y(t.content.tracks,e))}}}:"gift"===t.type?{type:t.type,header:t.header,content:Object.assign(Object.assign({},t.content),{track:m(t.content.track,e.find(function(e){return e.id===t.content.track.albumId}))})}:t})}(r.blocks,r.albums):[];return e.etag=r.etag,e.state={blocks:t?e.state.blocks.concat(i):r.modified?i:e.state.blocks,marker:r.marker||null},e.state})},te.prototype.loadTracks=function(t){return this.api.get("popTracks",{tuner:t}).then(function(t){var e=t.tracks,r=t.albums;return d.of(y(e,r))})},te.prototype.loadTopTracksTab=function(t){void 0===t&&(t="all");var e=this.state.blocks.find(function(t){return"top_tracks_list"===t.type});if(e){var r=e.content.tracks[t];return e.content.selected=t,r?Promise.resolve(r):this.loadTracks(t).then(function(r){return e.content.tracks[t]=r,r})}return Promise.reject()},te.prototype.hideSubscriptionBlock=function(){var t=this;return this.state.blocks=this.state.blocks.filter(function(t){return"subscription"!==t.type}),this.api.post("hideFeaturedBlock",{typeName:"subscription"}).then(function(){return t.state})},te.prototype.reset=function(){this.state=void 0,this.etag=void 0};var ee=function(t){this.api=t};ee.prototype.loadTracks=function(){return this.api.get("featuredPlaylist").then(function(t){return d.of(y(t.tracks,t.albums),t.chunk)})},Mt([Dt],ee.prototype,"loadTracks",null);var re=function(t,e){this.store=t,this.api=e};re.prototype.fetch=function(t,r){return this.api.get("custom",{ids:t,plid:r}).then(function(t){var r=t.tracks[0];if(!r)throw e.success("music.api.error","track","error.notfound"),new Error("error.notfound");return m(r,t.albums[0])})},re.prototype.fetchSimilarTracks=function(t){return this.api.get("similarTracksByIds",{trackIds:t,count:100}).then(function(t){return{type:t.type,items:y(t.tracks,t.albums)}})},re.prototype.loadTracks=function(t,e){return this.api.get("custom",{ids:t,plid:e||"track"}).then(function(t){return y(t.tracks,t.albums)})},re.prototype.add=function(t,r,i){var s=this,n=!0;Array.isArray(t)||("string"==typeof t.id&&(t.id=Number(t.id)),n="name"in t,t=[t]);var a=this.store.getState(),o=r?"playlists":"users",u=r?String(r):a.currentUser.id;return n&&this.store.dispatch({type:"tracks/add_tracks",branch:o,id:u,tracks:t}),this.api.post("like",{pid:r,ctx:t[0].ctx,tid:t.map(function(t){return t.id}).reverse().join(","),count:t.length,similarTracksCount:i}).then(function(t){var r=y(t.tracks,t.albums),i=t.similarTracks?y(t.similarTracks,t.albums):void 0;return function(t,r){t.forEach(function(t){r&&t.id===r.id&&(it=!0),e.success(et,"like",JSON.stringify({trackId:t.id,ctx:t.ctx,releaseId:t.releaseId,startTimestamp:Date.now(),osType:rt}))})}(r,a.player.track),s.store.dispatch({type:"tracks/add_tracks",branch:o,id:u,tracks:r,images:t.images,totalTracks:t.totalTracks}),i})},re.prototype.download=function(t){return this.api.get("isDownloaded",{tid:t}).then(function(t){return t.isBought?{isBought:!0,title:t.artist+"-"+t.title,downloadUrl:E(t.downloadUrl)+"&fn="+encodeURIComponent(name)}:t})},Mt([Dt],re.prototype,"fetch",null),Mt([Dt],re.prototype,"fetchSimilarTracks",null);var ie=function(t){this.api=t};function se(t,e,r,i){var s=f(e),n=f(r),a=f(i);return t.map(function(t){return{owner:ne(t.ownerRef,s,n),time:t.time,tracks:y(t.tracks,a),tracksCount:t.tracksCount,mediatopicId:t.mediatopicId}})}function ne(t,e,r){var i=t.split(":"),s=i[0],n=i[1];return"user"===s?function(t,e){return{ref:t,type:"user",name:e.fullName,image:e.url4}}(t,e[n]):function(t,e){return{ref:t,type:"group",name:e.name,image:e.imageUrl}}(t,r[n])}ie.prototype.load=function(t,e){return void 0===e&&(e=30),this.api.get("activity",{start:t,count:e}).then(function(t){var e=t.data,r=t.friends,i=t.groups,s=t.albums,n=t.hasMore,a=t.forwardMarker;return{items:se(e,r,i,s),hasMore:n,marker:a}})};var ae=function(t,e){this.api=t,this.showcase=e};ae.prototype.load=function(t){return this.api.get("newbie",{count:100,marker:t})},ae.prototype.select=function(t,e,r){return void 0===r&&(r=4),this.api.get("newbieSimilar",{artistId:t,marker:e,count:r})},ae.prototype.submit=function(t){return this.showcase.reset(),this.api.post("newbieComplete",{artists:t.join(",")})};var oe=0,ue=function(t,e){this.store=t,this.api=e};ue.prototype.upload=function(t,e){var r=this,i=t.map(function(t){return{cid:oe++,status:"uploading",file:t,pid:e}});this.store.dispatch({type:"upload/append",uploads:i}),i.forEach(function(t){return r.upload0(t)})},ue.prototype.retry=function(t){var e=this.store.getState().uploads.get(t);this.store.dispatch({type:"upload/reset",cid:t}),this.upload0(e)},ue.prototype.remove=function(t){this.store.dispatch({type:"upload/remove",cid:t})},ue.prototype.setCompleted=function(t,e,r,i){var s=this,n=Array.from(this.store.getState().uploads.values()).find(function(e){return e.uploadId===t});n&&("failed"===e?this.store.dispatch({type:"upload/set_error",cid:n.cid,error:new Error("processing")}):this.api.get("custom",{ids:r,plid:"track"}).then(function(t){s.remove(n.cid),s.store.dispatch({type:"tracks/add_uploaded_tracks",id:i?String(i):s.store.getState().currentUser.id,branch:i?"playlists":"users",tracks:y(t.tracks,t.albums)})}))},ue.prototype.upload0=function(t){var r=this,i=Date.now(),s=t.cid,n=t.file,a=t.pid;e.success("music.upload","start"),this.uploadTrack(s,n,a).then(function(){e.duration("music.upload",Date.now()-i,"finish"),r.store.dispatch({type:"upload/finish",cid:s})}).catch(function(t){e.duration("music.upload.error",Date.now()-i,t),r.store.dispatch({type:"upload/set_error",cid:s,error:t})})},ue.prototype.uploadTrack=function(t,e,r){var i=this,s=e.size;return s<245760?Promise.reject("limit_min"):s>157286400?Promise.reject("limit_max"):this.api.post("upload/init",{rnd:""+Date.now()+t}).then(function(s){var n=s.uploadId;return i.store.dispatch({type:"upload/set_id",cid:t,uploadId:n}),i.api.createURL("upload/chunked").then(function(s){return i.performUpload(e,s,t,n,r)})})},ue.prototype.performUpload=function(e,r,i,s,n){var a=this;return new Promise(function(o,u){new Promise(function(e,r){t(["FileAPI"],e,r)}).then(function(t){t.upload({url:r,data:{uploadId:s,pid:n},files:{audio:e},chunkSize:1*t.MB,chunkUploadRetry:5,fileupload:function(e){return t.log("Start upload "+e.name)},progress:function(t){var e=Math.min(1,t.loaded/t.total);a.store.dispatch({type:"upload/set_progress",cid:i,progress:e})},filecomplete:function(e,r,i){e&&"OK"!==e?(t.log("Upload "+i.name+" failed with "+e),u(e)):(t.log("Upload "+i.name+" done"),o())}})})})};var ce=function(t,e,r,i,s,n,a,o,u,c,p,l){this.api=t,this.artists=e,this.albums=r,this.playlists=i,this.users=s,this.groups=n,this.collections=a,this.tracks=o,this.library=u,this.radio=c,this.showcase=p,this.featured=l};function pe(t,e){return function(r,i){switch(r){case 10:return le(-26);case 14:return le(26,i);case 3:var s=t.getState().collections[i];return s&&s?le(26,String(s.playlist.playlistId)):Promise.reject();case 11:return le(20,i);case 27:return le(55,i);case 1:return e.fetch(Number(i)).then(function(t){if(t.albums){var e=t.albums[0];if(e)return le(1,String(e.id))}return Promise.reject()});case 19:case 8:return le(r,i);default:return Promise.reject()}}}function le(t,e){return Promise.resolve({type:t,id:e})}ce.prototype.loadMore=function(t,e){switch(t){case 3:return this.collections.loadTracks(Number(e));case 4:return this.users.loadTracks(e);case 61:return this.groups.loadTracks(e);case 10:return this.library.loadTracks();case-26:return this.library.loadSimilarTracks();case 14:case 62:return this.playlists.loadTracks(Number(e));case 26:return this.playlists.loadSimilarTracks(Number(e));case 20:return this.artists.loadSimilarTracks(Number(e))}return Promise.reject("can-not-load")},ce.prototype.fetchTracks=function(t,e,r){switch(t){case 1:return this.albums.fetchTracks(Number(e),r);case 11:return this.artists.fetchTracks(Number(e),r);case 20:return this.artists.fetchSimilarTracks(Number(e));case 14:case 62:return this.playlists.fetchTracks(Number(e),r);case 26:return this.playlists.fetchSimilarTracks(Number(e));case 4:return this.users.fetchTracks(e,r);case 61:return this.groups.fetchTracks(e,r);case 3:return this.collections.fetchTracks(Number(e),r);case 10:return this.library.fetchTracks();case-26:return this.library.fetchSimilarTracks();case 27:return this.tracks.fetch(Number(e),r).then(function(t){return d.of([t])});case-27:return this.tracks.loadTracks(e,r).then(function(t){return d.of(t)});case 55:return this.tracks.fetchSimilarTracks(Number(e)).then(function(t){var e=t.items;return d.of(e)});case 19:return this.radio.loadTracks(e);case 8:return this.showcase.loadTracks(e);case 60:return this.featured.loadTracks();case 33:case 34:case 35:return this.api.get("chatpl",{start:e,before:100,count:100}).then(function(t){return d.of(y(t.tracks,t.albums))});default:return Promise.reject("not-supported-playlist-type-"+t)}};var de=!1;return function(t){var e=new u,r=qt(t),i=new Lt(e),s=new Ut(e),n=new Bt(r,e),a=new Kt(r,e,n),o=new Wt(r,e),c=new Qt(r,e,a,o),p=new Jt(r,e),l=new re(r,e),d=new zt(e),h=new Yt(e),f=new te(e),m=new ee(e),y=new Zt(e),g=new ie(e),k=new ae(e,f),v=new ue(r,e),b=new lt({userId:t,state:r.getState().player,api:e,queueFetcher:new ce(e,i,s,c,n,o,p,l,a,h,f,m),chooseNextPlaylist:pe(r,s)});return b.subscribe(Ct(r)),{api:e,artists:i,albums:s,playlists:c,users:n,groups:o,collections:p,tracks:l,sharing:d,library:a,radio:h,showcase:f,featured:m,search:y,activity:g,newbie:k,player:b,uploads:v,init:function(){return function(t,e,r,i,s){return de?Promise.resolve():(de=!0,e.get("init",{activityCount:-1,groupRecCount:0,checkNewActivity:!0}).then(function(t){r.dispatch(Object.assign({type:"app/init"},t)),t.lastPlayedStatus?i.restore(t.lastPlayedStatus.type,t.lastPlayedStatus.playlistId):i.restore(8)}).catch(function(){i.restore(8),s.updatePlaylists(),r.dispatch({type:"app/init",userId:t,featuredPlaylist:!1,subscribed:!1})}))}(t,e,r,b,a)},getState:function(){return r.getState()},subscribe:function(t){r.subscribe(t)}}}});
