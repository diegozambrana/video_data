define(["OK/utils/throttle","OK/utils/utils"],(function(t,i){"use strict";var e={},s="top",o="scroll",n="bottom",r="up",h="down",l=document.documentElement.classList.contains("small-toolbar")?48:76,c=i.gwtExperimentsCfg.mch;function a(t){return t.getBoundingClientRect().top+window.pageYOffset}function d(i){this.fixedTopThreshold=l,this.wrapperAbsoluteTop=0,this.topShift=0,this.stickyWrapper=i,this.stickyContainer=document.querySelector(i.getAttribute("data-sticky-container"))||i.firstChild,this.scrollContainer=document.querySelector(i.getAttribute("data-scroll-container"))||window,this.mainContentColumn=document.querySelector(i.getAttribute("data-main-content-column")),this.scrollHandler=t(10,this.onScroll.bind(this)),this.resizeHandler=t(10,this.onResize.bind(this)),this.init(!0),this.render(),this.scrollContainer.addEventListener("scroll",this.scrollHandler,!1),window.addEventListener("resize",this.resizeHandler,!1)}function p(t){return t.getAttribute("data-sticky-id")}return d.prototype.init=function(t){var i=a(this.stickyWrapper);if(this.scrollDelta=0,this.scrollPosition=window.pageYOffset,this.scrollDirection=null,this.scrollPosition<150&&(t=!0),t)this.setTopShift(0),this.setState(o);else if(this.wrapperAbsoluteTop&&this.topShift&&this.state===o){var e=this.topShift+(this.wrapperAbsoluteTop-i);this.setTopShift(e),this.setState(o)}this.state===o&&(this.wrapperAbsoluteTop=i)},d.prototype.onScroll=function(){var t=window.pageYOffset;t!==this.scrollPosition&&(this.scrollDelta=t-this.scrollPosition,this.scrollDirection=this.scrollDelta>0?h:r,this.scrollPosition=t,this.render())},d.prototype.onResize=function(){this.render()},d.prototype.destroy=function(){this.scrollContainer.removeEventListener("scroll",this.scrollHandler),window.removeEventListener("resize",this.resizeHandler)},d.prototype.setState=function(t){var i=this.stickyContainer.classList;switch(t){case s:i.remove("__fixed-bottom"),i.add("__fixed-top"),this.stickyContainer.style.marginTop=0;break;case o:i.remove("__fixed-top","__fixed-bottom"),this.stickyContainer.style.marginTop=this.topShift+"px";break;case n:i.remove("__fixed-top"),i.add("__fixed-bottom"),this.stickyContainer.style.marginTop=0}this.state=t},d.prototype.setTopShift=function(t){this.topShift!==t&&(this.topShift=t<0?0:t)},d.prototype.render=function(){var t=window.pageYOffset,i=window.innerHeight-this.fixedTopThreshold,e=this.stickyContainer.getBoundingClientRect(),l=e.height,d=a(this.stickyWrapper);if(c&&OK.Layers.isAnyLayerOpened||!(document.documentElement.scrollHeight-document.body.clientHeight<t))if(document.documentElement.scrollHeight<=d+l)this.init(!0);else if(this.mainContentColumn&&this.stickyWrapper.clientHeight>this.mainContentColumn.clientHeight+12)this.init(!0);else if(l<=i)t>d-this.fixedTopThreshold?this.setState(s):this.init(!0);else{if(this.scrollDirection===r){if(d-this.fixedTopThreshold>t)return void this.init(!0);switch(this.state){case o:e.top>this.fixedTopThreshold&&this.setState(s);break;case n:this.setTopShift(t+e.top-d-this.scrollDelta),this.setState(o)}}if(this.scrollDirection===h)switch(this.state){case s:this.setTopShift(t+e.top-d),this.setState(o);break;case o:e.bottom<=window.innerHeight&&this.setState(n)}null===this.scrollDirection&&0===this.topShift&&t>d-this.fixedTopThreshold&&this.setState(s)}},{StickyBlockConstructor:d,activate:function(t){var i=p(t),s=new d(t);if(!i)throw new Error("data-sticky-id must be specified");return e[i]=s,s},deactivate:function(t){var i=p(t);i&&(e[i].destroy(),delete e[i])}}}));