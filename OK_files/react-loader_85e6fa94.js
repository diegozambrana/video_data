define(["module","OK/logger","OK/capture"],(function(e,t,r){"use strict";var a=e.config().baseUrl||"/res/react",n=["REACT/vendors","REACT/core","OK/pts","OK/pms","OK/webapi","OK/css-loader","OK/LazyIconsCache"],o={INIT:"app-block:init",ACTIVATE:"app-block:activate",DEACTIVATE:"app-block:deactivate",ERROR:"app-block:error",REACT_ERROR:"app-block:react-error",LOG:"app-block:log",READY:"app-block:ready"},i="app-block-inited",c=function(){this.element=null,this.tagName="",this.appModule=null};function s(e){for(var t=(e||"").split(","),r=[],a=0,n=t.length;a<n;a++)t[a]&&r.push(t[a].trim());return r}function u(t){return require(t.modules,t.resolve,(function(r){var a=r.requireModules,n=e.config().retryRequireLoad||0,o=t.step||1,i=o<=n,c=i||e.config().alwaysUndefOnError;if(a&&c&&a.forEach((function(e){requirejs.undef(e)})),!a||!i)return l(t.tagName,t.error,function(e){var t=e.originalError||e;return{message:t.message||"",requireType:e.requireType,requireModules:e.requireModules,stack:t.stack||""}}(r)),void t.reject(r);u(Object.assign({},t,{modules:a,step:o+1}))}))}function d(e){return a+"/"+e}function l(e,r,a){console.error(e,r,a);var n=a;"object"==typeof a&&(n=Object.keys(a).map((function(e){var t=a[e];return e+"="+("string"==typeof t?t:JSON.stringify(t))})).join("\n")),t.clob("react-error",n,e,r)}function f(e){return(Math.floor(e)+"").split("").map((function(e,t){return t?"0":e})).join("")}return(c.prototype.activate=function(e){this.element=e,this.tagName=e.tagName.toLowerCase(),this.activateStartTime=performance.now();var t=this;if(!e)return Promise.reject(new Error("Element is not provided"));var r=e.getAttribute("data-react"),a=e.getAttribute("data-css"),o=s(e.getAttribute("data-l10n")),i=s(e.getAttribute("data-cfg")),c=s(e.getAttribute("data-require-modules"));return r?function(e,t,r,a,o,i){var c=["OK/react-loader!"+d(t)];r&&c.push("OK/css-loader!"+d(r));a.forEach((function(e){c.push("OK/pts!"+e)})),o.forEach((function(e){c.push("OK/pms!"+e)}));const s=n.concat(i||[]);return new Promise((function(t,r){u({tagName:e,reject:r,modules:s,error:"react-loading-libs-error",resolve:function(){u({tagName:e,reject:r,modules:c,error:"react-loading-dependencies-error",resolve:t})}})}))}(t.tagName,r,a,o,i,c).then((function(e){try{return t.appModule=e,t.render()}catch(e){throw l(t.tagName,"react-loader-render-func-error",{message:e.message,stack:e.stack}),e}})):Promise.reject(new Error("Module path not valid"))},c.prototype.deactivate=function(){this.appModule&&this.appModule.tags[this.tagName].destroy(this.element)},c.prototype.render=function(){var e=this.element,a=function(e){var t={};if(e.hasAttributes())for(var r=e.attributes,a=r.length-1;a>=0;a--)t[r[a].name]=r[a].value;return t}(e),n=function(e){var t,r,a,n={},o=[],i=[];for(Array.from(e.childNodes).forEach((function(t){if(1===t.nodeType){var r,a=[],n=t.tagName.toLowerCase();"template"===n?(a=Array.from(((r=t).content||r).children||[]),i.push(t)):a="ui-part"===n?[t]:Array.from(function(e){return e.getElementsByTagName("ui-part")}(e)),o=o.concat(a)}})),r=o.length-1;r>=0;r--)"ui-part"===(t=o[r]).tagName.toLowerCase()&&(a=t.innerHTML)&&(n[t.getAttribute("data-part-id")]=a);return i.forEach((function(t){e.removeChild(t)})),n}(e),c=this.tagName;!function(e){var t=Array.from(e.getElementsByTagName("span")),r=require("OK/LazyIconsCache");t.forEach((function(e){if(e.hasChildNodes()&&"svg"===e.firstChild.tagName){var t=e.getAttribute("data-icon-name");if(t){var a=r.getInstance(t);a.html||a.makeNode(e.innerHTML)}}}))}(e),e.addEventListener(o.INIT,(function(t){Object.assign(e,t.detail),e.setAttribute(i,"true"),e.dispatchEvent(new CustomEvent(o.READY,{bubbles:!1,cancelable:!1}))})),e.addEventListener(o.ACTIVATE,(function(e){r.activate(e.detail.element)})),e.addEventListener(o.DEACTIVATE,(function(e){const t=e.detail.element;r.deactivateOnlyElement?r.deactivateOnlyElement(t):r.deactivate(t)})),e.addEventListener(o.ERROR,(function(e){console.error(c,e.detail),t.error(c,e.detail)})),e.addEventListener(o.REACT_ERROR,(function(e){l(c,e.detail.code,e.detail.data)})),e.addEventListener(o.LOG,(function(e){t[e.detail.type].apply(t,e.detail.params||[])}));var s=this.appModule.tags[c];try{t.success("react-render-try",c,f(performance.now()-this.activateStartTime)),s.render({tagName:c,attrs:a,parts:n,node:e}),t.success("react-render-success",c,f(performance.now()-this.activateStartTime))}catch(e){l(c,"react-first-render-error",{message:e.message,stack:e.stack})}},c.onAppReady=function(e){return new Promise((function(t){e.getAttribute(i)?t(e):e.addEventListener(o.READY,(function(){t(e)}))}))},c.load=function(e,t,r){if(!document.head&&!document.body)throw new Error("DOM must be loaded");t([e],r,(function(e){r.error&&r.error(e)}))},c)}));