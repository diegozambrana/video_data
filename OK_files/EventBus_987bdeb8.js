define(["OK/EventFactory"],(function(e){"use strict";var t=e.create();function n(e){this.prefix=e.prefix,this.name=e.name,this.listeners=new Map}return n.EVENT_NAME="okeventbus",n.registeredBuses=new Set,n.getRegisteredBuses=function(){return n.registeredBuses},n.getHost=function(){return t},n.createEvent=function(e){return new CustomEvent(n.EVENT_NAME,{detail:e,bubbles:!1,cancelable:!0})},n.on=function(e){if(t.list.includes(e))throw new Error("EventBus: повторное добавление обработчика");t.attach(e)},n.off=function(e){t.detach(e)},n.emit=function(e){var r=n.createEvent(e);return t.trigger(r),!r.defaultPrevented},n.findRegistered=function(e){var t=null;return n.registeredBuses.forEach((function(n){!t&&n.isMe(e)&&(t=n)})),t},n.create=function(e){return n.getInstance(e)},n.getInstance=function(e){var t=n.findRegistered(e);return t||(t=new n(e),n.getRegisteredBuses().add(t)),t},n.prototype={emit:function(e,t){return n.emit({prefix:this.prefix,name:this.name,data:e,target:t})},on:function(e,t){var r=this.makeListener(e,t);n.on(r)},off:function(e){var t=this.listeners.get(e);t&&(t.bus=void 0,n.off(t),this.listeners.delete(e))},isMe:function(e){return this.name===e.name&&this.prefix===e.prefix},makeListener:function(e,t){if(this.listeners.has(e))throw new Error("EventBus["+this.prefix+", "+this.name+"]: повторное добавление обработчика");var n=function(n){var r=n.detail;if(!n.defaultPrevented&&this.isMe(r)&&(!t||!r.target||t!==r.target))return e(r.data,n)}.bind(this);return this.listeners.set(e,n),n}},n}));